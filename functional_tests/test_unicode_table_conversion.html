<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unicode Table Conversion Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.3/dist/purify.min.js"></script>
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
        }
        .unicode-table {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin: 0.5rem 0;
            font-family: 'Courier New', monospace;
            white-space: pre;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Unicode Table Conversion Test</h1>
        
        <div class="test-section">
            <h3>Input: Unicode Box-Drawing Table</h3>
            <div class="unicode-table" id="input-table"></div>
        </div>
        
        <div class="test-section">
            <h3>Converted Markdown</h3>
            <pre id="markdown-output" class="bg-light p-3"></pre>
        </div>
        
        <div class="test-section">
            <h3>Final HTML Table</h3>
            <div id="html-output"></div>
        </div>
    </div>

    <script>
        // Configure marked with GFM (tables support)
        marked.setOptions({
            gfm: true,
            tables: true,
            breaks: false,
            pedantic: false,
            sanitize: false,
            smartypants: false
        });

        // Configure DOMPurify to allow table elements
        const purifyConfig = {
            ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'a', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'span', 'div'],
            ALLOWED_ATTR: ['href', 'target', 'class', 'id']
        };

        // Unicode table conversion function
        function convertUnicodeTableToMarkdown(content) {
            const unicodeTableRegex = /┌[─┬┐]*┐[\s\S]*?└[─┴┘]*┘/g;
            return content.replace(unicodeTableRegex, (match) => {
                const lines = match.split('\n');
                const dataRows = lines.filter(line => 
                    line.includes('│') && 
                    !line.match(/^[┌├└┬┴┐┤┘─│┼]*$/) &&
                    line.trim() !== ''
                );
                
                if (dataRows.length === 0) return match;
                
                const headers = dataRows[0].split('│')
                    .map(cell => cell.trim())
                    .filter(cell => cell !== '');
                
                if (headers.length === 0) return match;
                
                const separator = '| ' + headers.map(() => '---').join(' | ') + ' |';
                const headerRow = '| ' + headers.join(' | ') + ' |';
                
                const bodyRows = dataRows.slice(1).map(row => {
                    const cells = row.split('│')
                        .map(cell => cell.trim())
                        .filter(cell => cell !== '');
                    return '| ' + cells.join(' | ') + ' |';
                });
                
                return '\n\n' + [headerRow, separator, ...bodyRows].join('\n') + '\n\n';
            });
        }

        // Test Unicode table
        const unicodeTable = `System Status Report:

┌─────────────────┬─────────┬────────────┬──────────────┐
│ Application     │ Version │ Status     │ Last Updated │
├─────────────────┼─────────┼────────────┼──────────────┤
│ Simple Chat     │ 0.229   │ Active     │ 2024-01-15   │
│ ESAM Agent      │ 1.2.3   │ Testing    │ 2024-01-14   │
│ Data Processor  │ 2.1.0   │ Active     │ 2024-01-13   │
│ API Gateway     │ 3.0.1   │ Active     │ 2024-01-12   │
│ User Service    │ 1.5.2   │ Active     │ 2024-01-11   │
└─────────────────┴─────────┴────────────┴──────────────┘

All systems are operational.`;

        // Display the original Unicode table
        document.getElementById('input-table').textContent = unicodeTable;

        // Convert to markdown
        const markdownContent = convertUnicodeTableToMarkdown(unicodeTable);
        document.getElementById('markdown-output').textContent = markdownContent;

        // Convert to HTML
        const htmlContent = DOMPurify.sanitize(marked.parse(markdownContent), purifyConfig);
        document.getElementById('html-output').innerHTML = htmlContent;

        // Add Bootstrap table classes
        const tables = document.querySelectorAll('#html-output table');
        tables.forEach(table => {
            table.className = 'table table-striped table-hover table-bordered';
        });

        console.log('✅ Unicode Table Conversion Test Complete');
        console.log('Original length:', unicodeTable.length);
        console.log('Markdown length:', markdownContent.length);
        console.log('HTML length:', htmlContent.length);
        console.log('Tables rendered:', tables.length);
    </script>
</body>
</html>