<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSV Table Conversion Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.3/dist/purify.min.js"></script>
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
        }
        .code-block {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin: 0.5rem 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>PSV Table Conversion Test</h1>
        
        <div class="test-section">
            <h3>Input: ESAM Agent PSV Format</h3>
            <div class="code-block" id="input-content"></div>
        </div>
        
        <div class="test-section">
            <h3>Processing Steps</h3>
            <div id="processing-steps"></div>
        </div>
        
        <div class="test-section">
            <h3>Final Output</h3>
            <div id="output"></div>
        </div>
    </div>

    <script>
        // Configure marked with GFM (tables support)
        marked.setOptions({
            gfm: true,
            tables: true,
            breaks: false,
            pedantic: false,
            sanitize: false,
            smartypants: false
        });

        // Configure DOMPurify to allow table elements
        const purifyConfig = {
            ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'a', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'span', 'div'],
            ALLOWED_ATTR: ['href', 'target', 'class', 'id']
        };

        // Table conversion functions from chat-messages.js
        function unwrapTablesFromCodeBlocks(content) {
            const codeBlockRegex = /```[\w]*\n((?:[^\n]*\|[^\n]*\n)+)```/g;
            return content.replace(codeBlockRegex, (match, tableContent) => {
                if (tableContent.includes('|') && tableContent.split('\n').filter(line => line.trim()).length > 1) {
                    return '\n' + tableContent.trim() + '\n';
                }
                return match;
            });
        }

        function convertUnicodeTableToMarkdown(content) {
            const unicodeTableRegex = /┌[─┬┐]*┐[\s\S]*?└[─┴┘]*┘/g;
            return content.replace(unicodeTableRegex, (match) => {
                const lines = match.split('\n');
                const dataRows = lines.filter(line => 
                    line.includes('│') && 
                    !line.match(/^[┌├└┬┴┐┤┘─│┼]*$/) &&
                    line.trim() !== ''
                );
                
                if (dataRows.length === 0) return match;
                
                const headers = dataRows[0].split('│')
                    .map(cell => cell.trim())
                    .filter(cell => cell !== '');
                
                if (headers.length === 0) return match;
                
                const separator = '| ' + headers.map(() => '---').join(' | ') + ' |';
                const headerRow = '| ' + headers.join(' | ') + ' |';
                
                const bodyRows = dataRows.slice(1).map(row => {
                    const cells = row.split('│')
                        .map(cell => cell.trim())
                        .filter(cell => cell !== '');
                    return '| ' + cells.join(' | ') + ' |';
                });
                
                return '\n\n' + [headerRow, separator, ...bodyRows].join('\n') + '\n\n';
            });
        }

        function convertPSVCodeBlockToMarkdown(content) {
            const psvCodeBlockRegex = /```[\w]*\n((?:[^|\n]+\|[^|\n]*(?:\|[^|\n]*)*\n)+)```/g;
            
            return content.replace(psvCodeBlockRegex, (match, psvContent) => {
                const lines = psvContent.trim().split('\n').filter(line => line.trim() && line.includes('|'));
                
                if (lines.length === 0) return match;
                
                const processedLines = lines.map(line => {
                    const cells = line.split('|').map(cell => cell.trim());
                    return '| ' + cells.join(' | ') + ' |';
                });
                
                if (processedLines.length === 1) {
                    const headers = lines[0].split('|').map(cell => cell.trim());
                    const separator = '| ' + headers.map(() => '---').join(' | ') + ' |';
                    return '\n\n' + processedLines[0] + '\n' + separator + '\n\n';
                } else {
                    const headers = lines[0].split('|').map(cell => cell.trim());
                    const separator = '| ' + headers.map(() => '---').join(' | ') + ' |';
                    
                    const limitedLines = processedLines.slice(0, Math.min(51, processedLines.length));
                    
                    let result = '\n\n' + limitedLines[0] + '\n' + separator + '\n';
                    for (let i = 1; i < limitedLines.length; i++) {
                        result += limitedLines[i] + '\n';
                    }
                    
                    if (processedLines.length > 51) {
                        const remaining = processedLines.length - 51;
                        result += `\n*... and ${remaining} more rows*\n`;
                    }
                    
                    return result + '\n';
                }
            });
        }

        // Test content - actual ESAM agent output format
        const testContent = `Here are the results from the ESAM export:

\`\`\`
Application Name|Version|Environment|Status|Last Updated
Simple Chat|0.229.004|Production|Active|2024-01-15
ESAM Agent|1.2.3|Development|Testing|2024-01-14
Data Processor|2.1.0|Staging|Active|2024-01-13
API Gateway|3.0.1|Production|Active|2024-01-12
User Service|1.5.2|Production|Active|2024-01-11
\`\`\`

This data shows the current application inventory with version information.`;

        // Display input
        document.getElementById('input-content').textContent = testContent;

        // Process step by step
        let step1 = unwrapTablesFromCodeBlocks(testContent);
        let step2 = convertUnicodeTableToMarkdown(step1);
        let step3 = convertPSVCodeBlockToMarkdown(step2);
        let finalHtml = DOMPurify.sanitize(marked.parse(step3), purifyConfig);

        // Display processing steps
        const stepsDiv = document.getElementById('processing-steps');
        stepsDiv.innerHTML = `
            <div class="mb-3">
                <strong>Step 1 - Unwrap Tables:</strong>
                <div class="code-block">${step1}</div>
            </div>
            <div class="mb-3">
                <strong>Step 2 - Convert Unicode Tables:</strong>
                <div class="code-block">${step2}</div>
            </div>
            <div class="mb-3">
                <strong>Step 3 - Convert PSV Tables:</strong>
                <div class="code-block">${step3}</div>
            </div>
        `;

        // Display final output
        document.getElementById('output').innerHTML = finalHtml;

        // Add Bootstrap table classes
        const tables = document.querySelectorAll('#output table');
        tables.forEach(table => {
            table.className = 'table table-striped table-hover table-bordered';
        });

        console.log('✅ PSV Table Conversion Test Complete');
        console.log('Original content length:', testContent.length);
        console.log('Final HTML length:', finalHtml.length);
        console.log('Tables found:', tables.length);
    </script>
</body>
</html>