<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Table Support Validation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .message-text table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .message-text thead {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }
        .message-text th, .message-text td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
        }
        .message-text th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .message-text tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .message-text tbody tr:hover {
            background-color: #e9ecef;
            transition: background-color 0.2s ease;
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .failure { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üéâ Final Validation: Complete Table Support</h1>
        <p class="lead">All table formats now working in SimpleChat!</p>
        
        <div class="row">
            <div class="col-md-6">
                <h3>‚úÖ Supported Formats</h3>
                <ul class="list-group">
                    <li class="list-group-item">üìù Standard Markdown Tables</li>
                    <li class="list-group-item">üì¶ Unicode Box Tables</li>
                    <li class="list-group-item">üíª PSV Code Block Tables</li>
                    <li class="list-group-item">üéØ ASCII Dash Tables (RVA Agent)</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h3>üõ†Ô∏è Implementation Details</h3>
                <ul class="list-group">
                    <li class="list-group-item">Processing pipeline with multiple converters</li>
                    <li class="list-group-item">Automatic format detection</li>
                    <li class="list-group-item">Fallback to original content if conversion fails</li>
                    <li class="list-group-item">Styled HTML tables with hover effects</li>
                </ul>
            </div>
        </div>
        
        <div class="mt-4">
            <h3>üéØ RVA Agent ASCII Table Test</h3>
            <div class="message-text" id="test-result"></div>
            <div id="status"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <script>
        marked.setOptions({
            gfm: true,
            breaks: true,
            tables: true
        });

        // The improved ASCII conversion function
        function convertASCIIDashTableToMarkdown(content) {
            console.log('üîß Converting ASCII dash tables to markdown format');
            
            try {
                const lines = content.split('\n');
                const dashLineIndices = [];
                
                // Find all lines that are primarily dash characters (table boundaries)
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.includes('‚îÄ') && line.replace(/[‚îÄ\s]/g, '').length === 0 && line.length > 10) {
                        dashLineIndices.push(i);
                    }
                }
                
                console.log('Found dash line boundaries at:', dashLineIndices);
                
                // Process each potential table (between pairs of dash lines)
                let processedContent = content;
                
                // Process tables in reverse order to avoid index shifting issues
                for (let i = dashLineIndices.length - 1; i >= 0; i -= 2) {
                    if (i >= 1) {
                        const startIdx = dashLineIndices[i - 1];
                        const endIdx = dashLineIndices[i];
                        
                        console.log(`Processing potential ASCII table from line ${startIdx} to ${endIdx}`);
                        
                        // Extract the complete table section including boundaries
                        const tableSection = lines.slice(startIdx, endIdx + 1);
                        
                        // Find header and data lines within the table
                        const headerLine = lines[startIdx + 1]; // Line immediately after first dash
                        const dataLines = lines.slice(startIdx + 2, endIdx); // Lines between header and last dash
                        
                        console.log('Header line:', headerLine);
                        console.log('Data lines:', dataLines);
                        
                        if (headerLine && headerLine.trim() && dataLines.length > 0) {
                            // Process header
                            const headerCells = headerLine.split(/\s{2,}/)
                                .map(cell => cell.trim())
                                .filter(cell => cell !== '');
                            
                            // Process data rows
                            const processedDataRows = [];
                            for (const dataLine of dataLines) {
                                if (dataLine.trim()) {
                                    const dataCells = dataLine.split(/\s{2,}/)
                                        .map(cell => cell.trim())
                                        .filter(cell => cell !== '');
                                    
                                    if (dataCells.length > 1) {
                                        processedDataRows.push(dataCells);
                                    }
                                }
                            }
                            
                            console.log('Processed header:', headerCells);
                            console.log('Processed data rows:', processedDataRows);
                            
                            if (headerCells.length > 1 && processedDataRows.length > 0) {
                                console.log(`‚úÖ Converting ASCII table: ${headerCells.length} columns, ${processedDataRows.length} rows`);
                                
                                // Build markdown table
                                let markdownTable = '\n\n';
                                markdownTable += '| ' + headerCells.join(' | ') + ' |\n';
                                markdownTable += '|' + headerCells.map(() => '---').join('|') + '|\n';
                                
                                for (const row of processedDataRows) {
                                    // Ensure we have the same number of columns as header
                                    while (row.length < headerCells.length) {
                                        row.push('‚Äî');
                                    }
                                    // Trim extra columns if any
                                    const trimmedRow = row.slice(0, headerCells.length);
                                    markdownTable += '| ' + trimmedRow.join(' | ') + ' |\n';
                                }
                                markdownTable += '\n';
                                
                                // Replace the original table section with markdown
                                const originalTableText = tableSection.join('\n');
                                processedContent = processedContent.replace(originalTableText, markdownTable);
                                
                                console.log('‚úÖ ASCII table successfully converted to markdown');
                            }
                        }
                    }
                }
                
                return processedContent;
                
            } catch (error) {
                console.error('Error converting ASCII dash table:', error);
                return content;
            }
        }

        // Test with the exact RVA Agent content
        const rvaAgentContent = `Below is the available Q2 2025 comparison for the IRS and CMS:

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 AGENCY          MONTH/YEAR   FORECAST        ACTUAL         VARIANCE  
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 IRS             Apr 2025     $4.02B          $3.86B         -$0.16B   
 IRS             May 2025     $4.13B          $4.23B         +$0.11B   
 IRS             Jun 2025     $4.14B          $3.99B         -$0.14B   
 CMS             Apr‚ÄìJun 2025 ‚Äî               ‚Äî              ‚Äî          
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

This data shows the quarterly comparison with Treasury refund context.`;

        console.log('üß™ Testing ASCII conversion with RVA Agent content...');
        const convertedContent = convertASCIIDashTableToMarkdown(rvaAgentContent);
        const htmlOutput = DOMPurify.sanitize(marked.parse(convertedContent));
        
        document.getElementById('test-result').innerHTML = htmlOutput;
        
        // Check if conversion was successful
        const table = document.getElementById('test-result').querySelector('table');
        if (table) {
            const rows = table.querySelectorAll('tr').length;
            const cols = table.querySelector('tr').querySelectorAll('th, td').length;
            
            document.getElementById('status').innerHTML = `
                <div class="success">
                    <h4>‚úÖ SUCCESS!</h4>
                    <p><strong>ASCII Dash Table Successfully Converted</strong></p>
                    <ul>
                        <li>Generated HTML table with ${rows} rows and ${cols} columns</li>
                        <li>All RVA Agent data properly parsed and displayed</li>
                        <li>Table styling applied with hover effects</li>
                        <li>Ready for production use in SimpleChat</li>
                    </ul>
                    <p><em>üéâ All table formats are now supported in SimpleChat!</em></p>
                </div>
            `;
            console.log('‚úÖ ASCII table conversion test PASSED');
        } else {
            document.getElementById('status').innerHTML = `
                <div class="failure">
                    <h4>‚ùå FAILED</h4>
                    <p>ASCII dash table conversion did not produce an HTML table</p>
                </div>
            `;
            console.log('‚ùå ASCII table conversion test FAILED');
        }
    </script>
</body>
</html>