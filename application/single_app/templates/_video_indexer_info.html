<!-- Azure Video Indexer Configuration Information Modal -->
<div class="modal fade" id="videoIndexerInfoModal" tabindex="-1" aria-labelledby="videoIndexerInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoIndexerInfoModalLabel">
                    <i class="bi bi-camera-video me-2"></i>
                    Azure AI Video Indexer Configuration Guide
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>What is Azure AI Video Indexer?</strong> Azure AI Video Indexer is a cloud application, part of Azure Applied AI Services, built on Azure AI services (such as Face, Translator, Speech, and Vision). It enables you to extract insights from your videos using managed identity authentication.
                </div>

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> This application uses <strong>Managed Identity authentication</strong> for Video Indexer. API keys are not supported.
                </div>

                <!-- Current Configuration Display -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Current Configuration</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>Video File Support Enabled:</strong>
                                <span id="modal-video-enabled" class="badge bg-secondary">No</span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Video Indexer Endpoint:</strong><br>
                                <code id="modal-video-endpoint">Not configured</code>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>Account ID:</strong><br>
                                <code id="modal-account-id">Not configured</code>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Location:</strong><br>
                                <code id="modal-location">Not configured</code>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>Resource Group:</strong><br>
                                <code id="modal-resource-group">Not configured</code>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Subscription ID:</strong><br>
                                <code id="modal-subscription-id">Not configured</code>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Creation -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Create Azure AI Video Indexer Account</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6>Prerequisites</h6>
                            <ul class="mb-3">
                                <li>An Azure subscription</li>
                                <li>At the subscription level, either the <strong>Owner</strong> role, or both <strong>Contributor</strong> and <strong>User Access Administrator</strong> roles</li>
                            </ul>
                        </div>

                        <div class="mb-4">
                            <h6>1. Create Resource in Azure Portal</h6>
                            <ol class="mb-3">
                                <li>In the Azure portal, select <strong>+ Create a resource</strong></li>
                                <li>Search for and select <strong>Azure AI Video Indexer</strong></li>
                                <li>On the Marketplace page, select <strong>Create</strong> and then select <strong>Azure AI Video Indexer</strong></li>
                                <li>Create a resource group (or select an existing one) and select a <strong>Region</strong></li>
                                <li>Enter an account name in the <strong>Resource name</strong> field</li>
                                <li>Connect the account to a <strong>Storage account</strong> (must be Standard StorageV2)</li>
                                <li>Select or create a <strong>User-assigned managed identity</strong></li>
                                <li>Agree to the terms and conditions and select <strong>Review + create</strong></li>
                                <li>When validation completes, select <strong>Create</strong></li>
                            </ol>
                        </div>

                        <div class="alert alert-warning">
                            <strong>Important:</strong> Storage accounts for Video Indexer must be a <strong>Standard StorageV2 (general-purpose v2)</strong> storage account.
                        </div>
                    </div>
                </div>

                <!-- Managed Identity Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-shield-check me-2"></i>Configure Managed Identity Authentication</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6>1. Enable System-Assigned Managed Identity on App Service</h6>
                            <ol class="mb-3">
                                <li>Navigate to your App Service in the Azure Portal</li>
                                <li>In the left menu, select <strong>Identity</strong></li>
                                <li>Under the <strong>System assigned</strong> tab, set <strong>Status</strong> to <strong>On</strong></li>
                                <li>Click <strong>Save</strong> and confirm the action</li>
                                <li>Once enabled, note the <strong>Object (principal) ID</strong> for reference</li>
                            </ol>
                        </div>

                        <div class="mb-4">
                            <h6>2. Assign Contributor Role to Video Indexer Resource</h6>
                            <ol class="mb-3">
                                <li>Navigate to your <strong>Video Indexer</strong> resource in the Azure Portal</li>
                                <li>In the left menu, select <strong>Access control (IAM)</strong></li>
                                <li>Click <strong>+ Add</strong> and select <strong>Add role assignment</strong></li>
                                <li>In the <strong>Role</strong> tab, search for and select <strong>Contributor</strong></li>
                                <li>Click <strong>Next</strong> to go to the <strong>Members</strong> tab</li>
                                <li>Select <strong>Assign access to:</strong> <strong>Managed identity</strong></li>
                                <li>Click <strong>+ Select members</strong></li>
                                <li>In the dropdown, select <strong>App Service</strong> as the managed identity type</li>
                                <li>Select your App Service from the list</li>
                                <li>Click <strong>Select</strong>, then <strong>Review + assign</strong></li>
                            </ol>
                        </div>

                        <div class="mb-4">
                            <h6>3. Gather Required Configuration Information</h6>
                            <p class="mb-2">From your Video Indexer resource in the Azure Portal, collect:</p>
                            <ul class="mb-3">
                                <li><strong>Account ID:</strong> Found in the resource <strong>Overview</strong> page</li>
                                <li><strong>Account Name:</strong> The resource name (displayed at the top)</li>
                                <li><strong>Resource Group:</strong> Shown in the <strong>Overview</strong> under <strong>Resource group</strong></li>
                                <li><strong>Subscription ID:</strong> Shown in the <strong>Overview</strong> under <strong>Subscription</strong></li>
                                <li><strong>Location:</strong> The Azure region (e.g., East US, West Europe) - use lowercase with no spaces (e.g., <code>eastus</code>, <code>westeurope</code>)</li>
                            </ul>
                        </div>

                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Why Managed Identity?</strong> Managed identities eliminate the need to manage credentials. Azure automatically handles authentication, providing better security and easier management.
                        </div>

                        <div class="alert alert-info">
                            <strong>Tip:</strong> All required information can be found in the Azure Portal by navigating to your Video Indexer resource and checking the <strong>Overview</strong> tab.
                        </div>
                    </div>
                </div>

                <!-- Configuration Values -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Required Configuration Values</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Field</th>
                                        <th>Description</th>
                                        <th>Example</th>
                                        <th>Required</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>API Endpoint</strong></td>
                                        <td>Azure Video Indexer API endpoint</td>
                                        <td><code>https://api.videoindexer.ai</code></td>
                                        <td><span class="badge bg-secondary">Default</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Resource Group</strong></td>
                                        <td>Name of the Azure resource group</td>
                                        <td><code>rg-videoindexer-prod</code></td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Subscription ID</strong></td>
                                        <td>Azure subscription GUID</td>
                                        <td><code>12345678-1234-1234-1234-123456789abc</code></td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Account Name</strong></td>
                                        <td>Name of your Video Indexer resource</td>
                                        <td><code>my-video-indexer</code></td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Location</strong></td>
                                        <td>Azure region (lowercase, no spaces)</td>
                                        <td><code>eastus</code>, <code>westeurope</code>, <code>northeurope</code></td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Account ID</strong></td>
                                        <td>GUID from Azure portal resource overview</td>
                                        <td><code>4d6768d0-dc53-43e8-a305-e4c90deb363a</code></td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>ARM API Version</strong></td>
                                        <td>Azure Resource Manager API version</td>
                                        <td><code>2024-01-01</code></td>
                                        <td><span class="badge bg-secondary">Default</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Timeout</strong></td>
                                        <td>Processing timeout in seconds</td>
                                        <td><code>600</code> (10 minutes)</td>
                                        <td><span class="badge bg-secondary">Default</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Important Notes -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Important Notes</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <h6><i class="bi bi-shield-check me-2"></i>Authentication Method</h6>
                            <p class="mb-0">This application uses <strong>Managed Identity authentication</strong> which provides secure, passwordless access to Azure Video Indexer. Managed Identity must be enabled on your App Service and granted the <code>Contributor</code> role on your Video Indexer resource.</p>
                        </div>

                        <div class="alert alert-warning mb-3">
                            <h6><i class="bi bi-key me-2"></i>API Keys Not Supported</h6>
                            <p class="mb-0">API key authentication is <strong>not supported</strong> for Azure Portal-created Video Indexer accounts. If you're using an older account from videoindexer.ai, you'll need to migrate to a managed identity-based ARM account for production use.</p>
                        </div>

                        <div class="alert alert-secondary mb-0">
                            <h6><i class="bi bi-cloud me-2"></i>Production Requirements</h6>
                            <p class="mb-2">For production use, ensure you have:</p>
                            <ul class="mb-0">
                                <li>Azure Resource Manager (ARM) Video Indexer account created via Azure Portal</li>
                                <li>System-Assigned Managed Identity enabled on your App Service</li>
                                <li>Contributor role assigned to the App Service identity on the Video Indexer resource</li>
                                <li>All required configuration values (resource group, subscription ID, account name, location, account ID)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Special Considerations -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Special Considerations</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <h6>Face Recognition Features</h6>
                            <p class="mb-2">Face identification, customization, and celebrity recognition features have limited access based on eligibility and usage criteria to support Responsible AI principles.</p>
                            <p class="mb-0">These features are only available to Microsoft managed customers and partners. Use the <a href="#" target="_blank">Face Recognition intake form</a> to apply for access.</p>
                        </div>

                        <div class="alert alert-info">
                            <h6>Azure Government</h6>
                            <ul class="mb-0">
                                <li>Only paid accounts are available</li>
                                <li>No manual content moderation available</li>
                                <li>Bing descriptions for celebrities/entities not presented</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Troubleshooting -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-tools me-2"></i>Troubleshooting</h6>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="videoIndexerTroubleshootingAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="troubleshootVI1">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVI1">
                                        Authentication errors (401/403) when uploading videos
                                    </button>
                                </h2>
                                <div id="collapseVI1" class="accordion-collapse collapse" data-bs-parent="#videoIndexerTroubleshootingAccordion">
                                    <div class="accordion-body">
                                        <ul>
                                            <li><strong>Verify managed identity is enabled:</strong> Check Azure Portal → App Service → Identity → System assigned should be "On"</li>
                                            <li><strong>Confirm Contributor role assignment:</strong> Video Indexer resource → Access control (IAM) → Role assignments → Ensure App Service is listed with Contributor role</li>
                                            <li><strong>Check Account ID:</strong> Verify Account ID matches exactly from Azure Portal → Video Indexer → Overview</li>
                                            <li><strong>Validate location:</strong> Ensure Location field matches your Azure region exactly (e.g., "eastus", not "East US")</li>
                                            <li><strong>Wait for role propagation:</strong> After assigning roles, wait 5-10 minutes for permissions to propagate</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="troubleshootVI2">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVI2">
                                        Video processing timeouts
                                    </button>
                                </h2>
                                <div id="collapseVI2" class="accordion-collapse collapse" data-bs-parent="#videoIndexerTroubleshootingAccordion">
                                    <div class="accordion-body">
                                        <ul>
                                            <li>Increase the timeout value for longer videos</li>
                                            <li>Check if your video file size exceeds limits</li>
                                            <li>Verify your storage account is properly connected</li>
                                            <li>Monitor Azure Service Health for any service issues</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="troubleshootVI3">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVI3">
                                        Missing video insights or poor transcription quality
                                    </button>
                                </h2>
                                <div id="collapseVI3" class="accordion-collapse collapse" data-bs-parent="#videoIndexerTroubleshootingAccordion">
                                    <div class="accordion-body">
                                        <ul>
                                            <li>Ensure video has clear audio for better transcription</li>
                                            <li>Check video format is supported (MP4, MOV, AVI, etc.)</li>
                                            <li>Verify language settings match your video content</li>
                                            <li>Consider uploading higher quality video files</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="troubleshootVI4">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVI4">
                                        Storage account connection issues
                                    </button>
                                </h2>
                                <div id="collapseVI4" class="accordion-collapse collapse" data-bs-parent="#videoIndexerTroubleshootingAccordion">
                                    <div class="accordion-body">
                                        <ul>
                                            <li>Confirm storage account is Standard StorageV2 (general-purpose v2)</li>
                                            <li>Check that managed identity has Storage Blob Data Contributor role</li>
                                            <li>Verify storage account and Video Indexer are in the same region</li>
                                            <li>Ensure no network restrictions are blocking access</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="troubleshootVI5">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVI5">
                                    API rate limiting or quota exceeded
                                    </button>
                                </h2>
                                <div id="collapseVI5" class="accordion-collapse collapse" data-bs-parent="#videoIndexerTroubleshootingAccordion">
                                    <div class="accordion-body">
                                        <ul>
                                            <li>Check Azure Monitor for API usage metrics and throttling events</li>
                                            <li>Review your Video Indexer pricing tier and quotas in Azure Portal</li>
                                            <li>Consider upgrading to a higher tier if processing volume is high</li>
                                            <li>Check for any quota alerts in Azure Cost Management</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="https://learn.microsoft.com/en-us/azure/azure-video-indexer/" target="_blank" class="btn btn-primary">
                    <i class="bi bi-book me-2"></i>View Full Documentation
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function updateVideoIndexerModalInfo() {
    const videoEnabled = document.getElementById('enable_video_file_support')?.checked || false;
    const videoEndpoint = document.getElementById('video_indexer_endpoint')?.value?.trim() || '';
    const accountId = document.getElementById('video_indexer_account_id')?.value?.trim() || '';
    const location = document.getElementById('video_indexer_location')?.value?.trim() || '';
    const resourceGroup = document.getElementById('video_indexer_resource_group')?.value?.trim() || '';
    const subscriptionId = document.getElementById('video_indexer_subscription_id')?.value?.trim() || '';
    const accountName = document.getElementById('video_indexer_account_name')?.value?.trim() || '';
    
    // Update modal status
    document.getElementById('modal-video-enabled').textContent = videoEnabled ? 'Yes' : 'No';
    document.getElementById('modal-video-enabled').className = videoEnabled ? 'badge bg-success' : 'badge bg-secondary';
    
    // Update configuration display
    document.getElementById('modal-video-endpoint').textContent = videoEndpoint || 'https://api.videoindexer.ai';
    document.getElementById('modal-resource-group').textContent = resourceGroup || 'Not configured';
    document.getElementById('modal-subscription-id').textContent = subscriptionId || 'Not configured';
    document.getElementById('modal-account-name').textContent = accountName || 'Not configured';
    document.getElementById('modal-location').textContent = location || 'Not configured';
    document.getElementById('modal-account-id').textContent = accountId || 'Not configured';
}

// Update modal info when the modal is opened
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('videoIndexerInfoModal');
    if (modal) {
        modal.addEventListener('show.bs.modal', updateVideoIndexerModalInfo);
    }
});
</script>
