# Builder stage: install dependencies in a virtualenv
FROM python:3.11-alpine AS builder

# Install system dependencies for Azure SQL connectivity
RUN apk update && apk add --no-cache \
    curl \
    gcc \
    g++ \
    musl-dev \
    unixodbc-dev \
    linux-headers \
    && curl -O https://download.microsoft.com/download/3/5/5/355d7943-a338-41a7-858d-53b259ea33f5/msodbcsql18_18.3.3.1-1_amd64.apk \
    && curl -O https://download.microsoft.com/download/3/5/5/355d7943-a338-41a7-858d-53b259ea33f5/mssql-tools18_18.3.1.1-1_amd64.apk \
    && apk add --allow-untrusted msodbcsql18_18.3.3.1-1_amd64.apk \
    && apk add --allow-untrusted mssql-tools18_18.3.1.1-1_amd64.apk \
    && rm -f msodbcsql18_18.3.3.1-1_amd64.apk mssql-tools18_18.3.1.1-1_amd64.apk

# Create app user and directory
RUN addgroup -g 1001 appgroup && adduser -D -u 1001 -G appgroup appuser
RUN mkdir -p /app && chown appuser:appgroup /app

WORKDIR /app

# Create a Python virtual environment
RUN python -m venv /app/venv && chown -R appuser:appgroup /app/venv

# Create and permission the flask_session directory
RUN mkdir -p /app/flask_session && chown -R appuser:appgroup /app/flask_session

# Copy requirements and install them into the virtualenv
COPY application/single_app/requirements.txt .
ENV PATH="/app/venv/bin:$PATH"
RUN pip install --no-cache-dir -r requirements.txt

FROM python:3.11-alpine

# Install runtime dependencies for Azure SQL connectivity
RUN apk update && apk add --no-cache \
    curl \
    unixodbc \
    && curl -O https://download.microsoft.com/download/3/5/5/355d7943-a338-41a7-858d-53b259ea33f5/msodbcsql18_18.3.3.1-1_amd64.apk \
    && apk add --allow-untrusted msodbcsql18_18.3.3.1-1_amd64.apk \
    && rm -f msodbcsql18_18.3.3.1-1_amd64.apk

# Create app user in runtime stage
RUN addgroup -g 1001 appgroup && adduser -D -u 1001 -G appgroup appuser

WORKDIR /app

ENV PYTHONUNBUFFERED=1
ENV PATH="/app/venv/bin:$PATH"

# Copy application code and set ownership
COPY --chown=appuser:appgroup application/single_app ./

# Copy the virtualenv from the builder stage
COPY --from=builder --chown=appuser:appgroup /app/venv /app/venv

# Copy the flask_session directory from the builder stage
COPY --from=builder --chown=appuser:appgroup /app/flask_session /app/flask_session

# Expose port
EXPOSE 5000

USER appuser:appgroup

ENTRYPOINT [ "python", "/app/app.py" ]