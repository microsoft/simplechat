{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "12894563845993036077"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "The Azure region where resources will be deployed.  \n- Region must align to the target cloud environment"
      }
    },
    "cloudEnvironment": {
      "type": "string",
      "allowedValues": [
        "AzureCloud",
        "AzureUSGovernment"
      ],
      "metadata": {
        "description": "The target Azure Cloud environment.\n- Accepted values are: AzureCloud, AzureUSGovernment\n- Default is AzureCloud"
      }
    },
    "appName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 12,
      "metadata": {
        "description": "The name of the application to be deployed.  \n- Name may only contain letters and numbers\n- Between 3 and 12 characters in length \n- No spaces or special characters"
      }
    },
    "environment": {
      "type": "string",
      "minLength": 2,
      "maxLength": 10,
      "metadata": {
        "description": "The dev/qa/prod environment or as named in your environment. This will be used to create resource group names and tags.\n- Must be between 2 and 10 characters in length\n- No spaces or special characters"
      }
    },
    "azdEnvironmentName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "metadata": {
        "description": "Name of the AZD environment"
      }
    },
    "imageName": {
      "type": "string",
      "metadata": {
        "description": "The name of the container image to deploy to the web app.\n- should be in the format <repository>:<tag>"
      }
    },
    "enterpriseAppClientId": {
      "type": "string",
      "metadata": {
        "description": "Azure AD Application Client ID for enterprise authentication.\n- Should be the client ID of the registered Azure AD application"
      }
    },
    "enterpriseAppServicePrincipalId": {
      "type": "string",
      "metadata": {
        "description": "Azure AD Application Service Principal Id for the enterprise application.\n- Should be the Service Principal ID of the registered Azure AD application"
      }
    },
    "enterpriseAppClientSecret": {
      "type": "securestring",
      "metadata": {
        "description": "Azure AD Application Client Secret for enterprise authentication.\n- Required if enableEnterpriseApp is true\n- Should be created in Azure AD App Registration and passed via environment variable\n- Will be stored securely in Azure Key Vault during deployment"
      }
    },
    "authenticationType": {
      "type": "string",
      "allowedValues": [
        "key",
        "managed_identity"
      ],
      "metadata": {
        "description": "Authentication type for resources that support Managed Identity or Key authentication.\n- Key: Use access keys for authentication (application keys will be stored in Key Vault)\n- managed_identity: Use Managed Identity for authentication"
      }
    },
    "configureApplicationPermissions": {
      "type": "bool",
      "metadata": {
        "description": "Configure permissions (based on authenticationType) for the deployed web application to access required resources.\n"
      }
    },
    "specialTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional object containing additional tags to apply to all resources."
      }
    },
    "enableDiagLogging": {
      "type": "bool",
      "metadata": {
        "description": "Enable diagnostic logging for resources deployed in the resource group. \n- All content will be sent to the deployed Log Analytics workspace\n- Default is false"
      }
    },
    "enablePrivateNetworking": {
      "type": "bool",
      "metadata": {
        "description": "Enable private endpoints and virtual network integration for deployed resources. \n- Default is false"
      }
    },
    "gptModels": {
      "type": "array",
      "defaultValue": [
        {
          "modelName": "gpt-4.1",
          "modelVersion": "2025-04-14",
          "skuName": "GlobalStandard",
          "skuCapacity": 150
        },
        {
          "modelName": "gpt-4o",
          "modelVersion": "2024-11-20",
          "skuName": "GlobalStandard",
          "skuCapacity": 100
        }
      ],
      "metadata": {
        "description": "Array of GPT model names to deploy to the OpenAI resource."
      }
    },
    "embeddingModels": {
      "type": "array",
      "defaultValue": [
        {
          "modelName": "text-embedding-3-small",
          "modelVersion": "1",
          "skuName": "GlobalStandard",
          "skuCapacity": 150
        },
        {
          "modelName": "text-embedding-3-large",
          "modelVersion": "1",
          "skuName": "GlobalStandard",
          "skuCapacity": 150
        }
      ],
      "metadata": {
        "description": "Array of embedding model names to deploy to the OpenAI resource."
      }
    },
    "allowedIpAddresses": {
      "type": "array",
      "defaultValue": [
        {
          "ipAddressOrRange": "0.0.0.0"
        }
      ]
    },
    "deployContentSafety": {
      "type": "bool",
      "metadata": {
        "description": "Enable deployment of Content Safety service and related resources.\n- Default is false"
      }
    },
    "deployRedisCache": {
      "type": "bool",
      "metadata": {
        "description": "Enable deployment of Azure Cache for Redis and related resources.\n- Default is false"
      }
    },
    "deploySpeechService": {
      "type": "bool",
      "metadata": {
        "description": "Enable deployment of Azure Speech service and related resources.\n- Default is false"
      }
    },
    "deployVideoIndexerService": {
      "type": "bool",
      "metadata": {
        "description": "Enable deployment of Azure Video Indexer service and related resources.\n- Default is false"
      }
    }
  },
  "variables": {
    "rgName": "[format('{0}-{1}-rg', parameters('appName'), parameters('environment'))]",
    "requiredTags": {
      "application": "[parameters('appName')]",
      "environment": "[parameters('environment')]",
      "azd-env-name": "[parameters('azdEnvironmentName')]"
    },
    "tags": "[union(variables('requiredTags'), parameters('specialTags'))]",
    "acrCloudSuffix": "[if(equals(parameters('cloudEnvironment'), 'AzureCloud'), '.azurecr.io', '.azurecr.us')]",
    "acrName": "[toLower(format('{0}{1}acr', parameters('appName'), parameters('environment')))]",
    "containerRegistry": "[format('{0}{1}', variables('acrName'), variables('acrCloudSuffix'))]",
    "containerImageName": "[format('{0}/{1}', variables('containerRegistry'), parameters('imageName'))]",
    "vNetName": "[format('{0}-{1}-vnet', parameters('appName'), parameters('environment'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2022-09-01",
      "name": "[variables('rgName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]"
    },
    {
      "condition": "[parameters('enablePrivateNetworking')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "virtualNetwork",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vNetName": {
            "value": "[variables('vNetName')]"
          },
          "addressSpaces": {
            "value": [
              "10.0.0.0/21"
            ]
          },
          "subnetConfigs": {
            "value": [
              {
                "name": "AppServiceIntegration",
                "addressPrefix": "10.0.0.0/24",
                "enablePrivateEndpointNetworkPolicies": true,
                "enablePrivateLinkServiceNetworkPolicies": true
              },
              {
                "name": "PrivateEndpoints",
                "addressPrefix": "10.0.2.0/24",
                "enablePrivateEndpointNetworkPolicies": true,
                "enablePrivateLinkServiceNetworkPolicies": true
              }
            ]
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "10221795613826494860"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "vNetName": {
              "type": "string"
            },
            "addressSpaces": {
              "type": "array"
            },
            "subnetConfigs": {
              "type": "array"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "copy": [
              {
                "name": "subnetIds",
                "count": "[length(parameters('subnetConfigs'))]",
                "input": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vNetName'), parameters('subnetConfigs')[copyIndex('subnetIds')].name)]"
              },
              {
                "name": "subnetNames",
                "count": "[length(parameters('subnetConfigs'))]",
                "input": "[parameters('subnetConfigs')[copyIndex('subnetNames')].name]"
              }
            ],
            "appServiceIntegrationSubnetIndex": "[indexOf(variables('subnetNames'), 'AppServiceIntegration')]",
            "privateEndpointIndex": "[indexOf(variables('subnetNames'), 'PrivateEndpoints')]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2021-05-01",
              "name": "[parameters('vNetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "copy": [
                  {
                    "name": "subnets",
                    "count": "[length(parameters('subnetConfigs'))]",
                    "input": {
                      "name": "[parameters('subnetConfigs')[copyIndex('subnets')].name]",
                      "properties": {
                        "addressPrefix": "[parameters('subnetConfigs')[copyIndex('subnets')].addressPrefix]",
                        "privateEndpointNetworkPolicies": "[if(parameters('subnetConfigs')[copyIndex('subnets')].enablePrivateEndpointNetworkPolicies, 'Enabled', 'Disabled')]",
                        "privateLinkServiceNetworkPolicies": "[if(parameters('subnetConfigs')[copyIndex('subnets')].enablePrivateLinkServiceNetworkPolicies, 'Enabled', 'Disabled')]",
                        "delegations": "[if(equals(parameters('subnetConfigs')[copyIndex('subnets')].name, 'AppServiceIntegration'), createArray(createObject('name', 'delegation', 'properties', createObject('serviceName', 'Microsoft.Web/serverFarms'))), createArray())]"
                      }
                    }
                  }
                ],
                "addressSpace": {
                  "addressPrefixes": "[parameters('addressSpaces')]"
                }
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "vNetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vNetName'))]"
            },
            "privateNetworkSubnetId": {
              "type": "string",
              "value": "[if(equals(variables('privateEndpointIndex'), -1), '', variables('subnetIds')[variables('privateEndpointIndex')])]"
            },
            "appServiceSubnetId": {
              "type": "string",
              "value": "[if(equals(variables('appServiceIntegrationSubnetIndex'), -1), '', variables('subnetIds')[variables('appServiceIntegrationSubnetIndex')])]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "logAnalytics",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16638534490731333297"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[toLower(format('{0}-{1}-la', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                }
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "logAnalyticsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', toLower(format('{0}-{1}-la', parameters('appName'), parameters('environment'))))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "applicationInsights",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16543999957549068652"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "logAnalyticsId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[toLower(format('{0}-{1}-ai', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('logAnalyticsId')]"
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "appInsightsName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-ai', parameters('appName'), parameters('environment')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyVault",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "3503710577838836741"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2024-11-01",
              "name": "[toLower(format('{0}-{1}-kv', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "accessPolicies": [],
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": false,
                "publicNetworkAccess": "Enabled",
                "enableRbacAuthorization": true
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', toLower(format('{0}-{1}-kv', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-kv', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardLogCategories.value]",
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]",
                "[resourceId('Microsoft.KeyVault/vaults', toLower(format('{0}-{1}-kv', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', toLower(format('{0}-{1}-kv', parameters('appName'), parameters('environment'))))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-kv', parameters('appName'), parameters('environment')))]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', toLower(format('{0}-{1}-kv', parameters('appName'), parameters('environment')))), '2024-11-01').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "condition": "[not(empty(parameters('enterpriseAppClientSecret')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storeEnterpriseAppSecret",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "secretName": {
            "value": "enterprise-app-client-secret"
          },
          "secretValue": {
            "value": "[parameters('enterpriseAppClientSecret')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "18077870757859157550"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "secretName": {
              "type": "string"
            },
            "secretValue": {
              "type": "securestring"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2025-05-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
              "properties": {
                "value": "[parameters('secretValue')]"
              }
            }
          ],
          "outputs": {
            "SecretUri": {
              "type": "string",
              "value": "[format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2025-05-01').vaultUri, parameters('secretName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "cosmosDB",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "keyVault": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "configureApplicationPermissions": {
            "value": "[parameters('configureApplicationPermissions')]"
          },
          "enablePrivateNetworking": {
            "value": "[parameters('enablePrivateNetworking')]"
          },
          "allowedIpAddresses": {
            "value": "[parameters('allowedIpAddresses')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "15046922718277168026"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "keyVault": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string"
            },
            "configureApplicationPermissions": {
              "type": "bool"
            },
            "enablePrivateNetworking": {
              "type": "bool"
            },
            "allowedIpAddresses": {
              "type": "array",
              "defaultValue": []
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-04-15",
              "name": "[toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "publicNetworkAccess": "Enabled",
                "databaseAccountOfferType": "Standard",
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ],
                "isVirtualNetworkFilterEnabled": "[if(parameters('enablePrivateNetworking'), true(), false())]",
                "ipRules": "[if(parameters('enablePrivateNetworking'), parameters('allowedIpAddresses'), createArray())]",
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                }
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment'))), 'SimpleChat')]",
              "properties": {
                "resource": {
                  "id": "SimpleChat"
                },
                "options": {}
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}/{2}', toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment'))), 'SimpleChat', 'settings')]",
              "properties": {
                "resource": {
                  "id": "settings",
                  "partitionKey": {
                    "paths": [
                      "/id"
                    ]
                  }
                },
                "options": {}
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment'))), 'SimpleChat')]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardLogCategories.value]",
                "metrics": []
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment'))))]",
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[and(equals(parameters('authenticationType'), 'key'), parameters('configureApplicationPermissions'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storeCosmosDbSecret",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVault')]"
                  },
                  "secretName": {
                    "value": "cosmos-db-key"
                  },
                  "secretValue": {
                    "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment')))), '2023-04-15').primaryMasterKey]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "18077870757859157550"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2025-05-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "SecretUri": {
                      "type": "string",
                      "value": "[format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2025-05-01').vaultUri, parameters('secretName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment'))))]"
              ]
            }
          ],
          "outputs": {
            "cosmosDbName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment')))]"
            },
            "cosmosDbUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(format('{0}-{1}-cosmos', parameters('appName'), parameters('environment')))), '2023-04-15').documentEndpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "azureContainerRegistry",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "acrName": {
            "value": "[variables('acrName')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "keyVault": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "configureApplicationPermissions": {
            "value": "[parameters('configureApplicationPermissions')]"
          },
          "enablePrivateNetworking": {
            "value": "[parameters('enablePrivateNetworking')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "7200761421625936333"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "acrName": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "keyVault": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string"
            },
            "configureApplicationPermissions": {
              "type": "bool"
            },
            "enablePrivateNetworking": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2025-04-01",
              "name": "[parameters('acrName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[if(parameters('enablePrivateNetworking'), 'Premium', 'Standard')]"
              },
              "properties": {
                "adminUserEnabled": true,
                "publicNetworkAccess": "Enabled"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
              "name": "[toLower(format('{0}-diagnostics', parameters('acrName')))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardLogCategories.value]",
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]",
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[and(equals(parameters('authenticationType'), 'key'), parameters('configureApplicationPermissions'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storeContainerRegistrySecret",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVault')]"
                  },
                  "secretName": {
                    "value": "container-registry-key"
                  },
                  "secretValue": {
                    "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2025-04-01').passwords[0].value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "18077870757859157550"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2025-05-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "SecretUri": {
                      "type": "string",
                      "value": "[format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2025-05-01').vaultUri, parameters('secretName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
              ]
            }
          ],
          "outputs": {
            "acrName": {
              "type": "string",
              "value": "[parameters('acrName')]"
            },
            "acrResourceGroup": {
              "type": "string",
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "searchService",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "keyVault": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "configureApplicationPermissions": {
            "value": "[parameters('configureApplicationPermissions')]"
          },
          "enablePrivateNetworking": {
            "value": "[parameters('enablePrivateNetworking')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "12409981559885193891"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "keyVault": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string"
            },
            "configureApplicationPermissions": {
              "type": "bool"
            },
            "enablePrivateNetworking": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2025-05-01",
              "name": "[toLower(format('{0}-{1}-search', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "basic"
              },
              "properties": {
                "hostingMode": "default",
                "publicNetworkAccess": "[if(parameters('enablePrivateNetworking'), 'Disabled', 'Enabled')]",
                "replicaCount": 1,
                "partitionCount": 1,
                "authOptions": {
                  "aadOrApiKey": {
                    "aadAuthFailureMode": "http403"
                  }
                },
                "disableLocalAuth": false
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Search/searchServices/{0}', toLower(format('{0}-{1}-search', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-search', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardLogCategories.value]",
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]",
                "[resourceId('Microsoft.Search/searchServices', toLower(format('{0}-{1}-search', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[and(equals(parameters('authenticationType'), 'key'), parameters('configureApplicationPermissions'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storeSearchServiceSecret",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVault')]"
                  },
                  "secretName": {
                    "value": "search-service-key"
                  },
                  "secretValue": {
                    "value": "[listAdminKeys(resourceId('Microsoft.Search/searchServices', toLower(format('{0}-{1}-search', parameters('appName'), parameters('environment')))), '2025-05-01').primaryKey]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "18077870757859157550"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2025-05-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "SecretUri": {
                      "type": "string",
                      "value": "[format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2025-05-01').vaultUri, parameters('secretName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', toLower(format('{0}-{1}-search', parameters('appName'), parameters('environment'))))]"
              ]
            }
          ],
          "outputs": {
            "searchServiceName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-search', parameters('appName'), parameters('environment')))]"
            },
            "searchServiceEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Search/searchServices', toLower(format('{0}-{1}-search', parameters('appName'), parameters('environment')))), '2025-05-01').endpoint]"
            },
            "searchServiceAuthencationType": {
              "type": "string",
              "value": "[parameters('authenticationType')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "docIntel",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "keyVault": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "configureApplicationPermissions": {
            "value": "[parameters('configureApplicationPermissions')]"
          },
          "enablePrivateNetworking": {
            "value": "[parameters('enablePrivateNetworking')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1403194626393613544"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "keyVault": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string"
            },
            "configureApplicationPermissions": {
              "type": "bool"
            },
            "enablePrivateNetworking": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-06-01",
              "name": "[toLower(format('{0}-{1}-docintel', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "kind": "FormRecognizer",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "publicNetworkAccess": "[if(parameters('enablePrivateNetworking'), 'Disabled', 'Enabled')]",
                "customSubDomainName": "[toLower(format('{0}-{1}-docintel', parameters('appName'), parameters('environment')))]"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', toLower(format('{0}-{1}-docintel', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-docintel', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardLogCategories.value]",
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]",
                "[resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-docintel', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[and(equals(parameters('authenticationType'), 'key'), parameters('configureApplicationPermissions'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storeDocumentIntelligenceSecret",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVault')]"
                  },
                  "secretName": {
                    "value": "document-intelligence-key"
                  },
                  "secretValue": {
                    "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-docintel', parameters('appName'), parameters('environment')))), '2025-06-01').key1]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "18077870757859157550"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2025-05-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "SecretUri": {
                      "type": "string",
                      "value": "[format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2025-05-01').vaultUri, parameters('secretName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-docintel', parameters('appName'), parameters('environment'))))]"
              ]
            }
          ],
          "outputs": {
            "documentIntelligenceServiceName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-docintel', parameters('appName'), parameters('environment')))]"
            },
            "diagnosticLoggingEnabled": {
              "type": "bool",
              "value": "[parameters('enableDiagLogging')]"
            },
            "documentIntelligenceServiceEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-docintel', parameters('appName'), parameters('environment')))), '2025-06-01').endpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storageAccount",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "keyVault": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "configureApplicationPermissions": {
            "value": "[parameters('configureApplicationPermissions')]"
          },
          "enablePrivateNetworking": {
            "value": "[parameters('enablePrivateNetworking')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1065428217831578633"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "keyVault": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string"
            },
            "configureApplicationPermissions": {
              "type": "bool"
            },
            "enablePrivateNetworking": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-09-01",
              "name": "[toLower(format('{0}{1}sa', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "publicNetworkAccess": "[if(parameters('enablePrivateNetworking'), 'Disabled', 'Enabled')]",
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "isHnsEnabled": true
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))), 'default', 'user-documents')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))), 'default', 'group-documents')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))), 'default')]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": [],
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.transactionMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]",
                "[resourceId('Microsoft.Storage/storageAccounts', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/blobServices/{1}', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))), 'default')]",
              "name": "[toLower(format('{0}-blob-diagnostics', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardLogCategories.value]",
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.transactionMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))), 'default')]",
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]",
                "[resourceId('Microsoft.Storage/storageAccounts', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[and(equals(parameters('authenticationType'), 'key'), parameters('configureApplicationPermissions'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storeStorageAccountSecret",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVault')]"
                  },
                  "secretName": {
                    "value": "storage-account-key"
                  },
                  "secretValue": {
                    "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment')))), '2022-09-01').keys[0].value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "18077870757859157550"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2025-05-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "SecretUri": {
                      "type": "string",
                      "value": "[format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2025-05-01').vaultUri, parameters('secretName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment'))))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[toLower(format('{0}{1}sa', parameters('appName'), parameters('environment')))]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', toLower(format('{0}{1}sa', parameters('appName'), parameters('environment')))), '2022-09-01').primaryEndpoints.blob]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "openAI",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "keyVault": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "configureApplicationPermissions": {
            "value": "[parameters('configureApplicationPermissions')]"
          },
          "gptModels": {
            "value": "[parameters('gptModels')]"
          },
          "embeddingModels": {
            "value": "[parameters('embeddingModels')]"
          },
          "enablePrivateNetworking": {
            "value": "[parameters('enablePrivateNetworking')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17726947983911725769"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "keyVault": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string"
            },
            "configureApplicationPermissions": {
              "type": "bool"
            },
            "gptModels": {
              "type": "array"
            },
            "embeddingModels": {
              "type": "array"
            },
            "enablePrivateNetworking": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-10-01",
              "name": "[toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "publicNetworkAccess": "[if(parameters('enablePrivateNetworking'), 'Disabled', 'Enabled')]",
                "customSubDomainName": "[toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment')))]"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardLogCategories.value]",
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]",
                "[resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            },
            {
              "copy": {
                "name": "aiModel",
                "count": "[length(concat(parameters('gptModels'), parameters('embeddingModels')))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('model-{0}-{1}', replace(concat(parameters('gptModels'), parameters('embeddingModels'))[copyIndex()].modelName, '.', '-'), copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "parent": {
                    "value": "[toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment')))]"
                  },
                  "modelName": {
                    "value": "[concat(parameters('gptModels'), parameters('embeddingModels'))[copyIndex()].modelName]"
                  },
                  "modelVersion": {
                    "value": "[concat(parameters('gptModels'), parameters('embeddingModels'))[copyIndex()].modelVersion]"
                  },
                  "skuName": {
                    "value": "[concat(parameters('gptModels'), parameters('embeddingModels'))[copyIndex()].skuName]"
                  },
                  "skuCapacity": {
                    "value": "[concat(parameters('gptModels'), parameters('embeddingModels'))[copyIndex()].skuCapacity]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "3668428745262748302"
                    }
                  },
                  "parameters": {
                    "parent": {
                      "type": "string"
                    },
                    "modelName": {
                      "type": "string"
                    },
                    "modelVersion": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "skuCapacity": {
                      "type": "int"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.CognitiveServices/accounts/deployments",
                      "apiVersion": "2025-06-01",
                      "name": "[format('{0}/{1}', parameters('parent'), parameters('modelName'))]",
                      "properties": {
                        "model": {
                          "format": "OpenAI",
                          "name": "[parameters('modelName')]",
                          "version": "[parameters('modelVersion')]"
                        }
                      },
                      "sku": {
                        "name": "[parameters('skuName')]",
                        "capacity": "[parameters('skuCapacity')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[and(equals(parameters('authenticationType'), 'key'), parameters('configureApplicationPermissions'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storeOpenAISecret",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVault')]"
                  },
                  "secretName": {
                    "value": "openAi-key"
                  },
                  "secretValue": {
                    "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment')))), '2024-10-01').key1]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "18077870757859157550"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2025-05-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "SecretUri": {
                      "type": "string",
                      "value": "[format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2025-05-01').vaultUri, parameters('secretName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment'))))]"
              ]
            }
          ],
          "outputs": {
            "openAIName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment')))]"
            },
            "openAIResourceGroup": {
              "type": "string",
              "value": "[resourceGroup().name]"
            },
            "openAIEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-openai', parameters('appName'), parameters('environment')))), '2024-10-01').endpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appServicePlan",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16108907418935593505"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-03-01",
              "name": "[toLower(format('{0}-{1}-asp', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "P1v3",
                "tier": "PremiumV3",
                "size": "P1v3",
                "capacity": 1
              },
              "kind": "app,linux,container",
              "properties": {
                "reserved": true,
                "perSiteScaling": false,
                "maximumElasticWorkerCount": 1,
                "hyperV": false,
                "targetWorkerCount": 0,
                "targetWorkerSizeId": 0
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/serverfarms/{0}', toLower(format('{0}-{1}-asp', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-asp', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": [],
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', toLower(format('{0}-{1}-asp', parameters('appName'), parameters('environment'))))]",
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', toLower(format('{0}-{1}-asp', parameters('appName'), parameters('environment'))))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appService",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "acrName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'azureContainerRegistry'), '2025-04-01').outputs.acrName.value]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "appServicePlanId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'appServicePlan'), '2025-04-01').outputs.appServicePlanId.value]"
          },
          "containerImageName": {
            "value": "[variables('containerImageName')]"
          },
          "azurePlatform": {
            "value": "[parameters('cloudEnvironment')]"
          },
          "cosmosDbName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'cosmosDB'), '2025-04-01').outputs.cosmosDbName.value]"
          },
          "searchServiceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'searchService'), '2025-04-01').outputs.searchServiceName.value]"
          },
          "openAiServiceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI'), '2025-04-01').outputs.openAIName.value]"
          },
          "openAiResourceGroupName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI'), '2025-04-01').outputs.openAIResourceGroup.value]"
          },
          "documentIntelligenceServiceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'docIntel'), '2025-04-01').outputs.documentIntelligenceServiceName.value]"
          },
          "appInsightsName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'applicationInsights'), '2025-04-01').outputs.appInsightsName.value]"
          },
          "enterpriseAppClientId": {
            "value": "[parameters('enterpriseAppClientId')]"
          },
          "enterpriseAppClientSecret": {
            "value": "[parameters('enterpriseAppClientSecret')]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "keyVaultUri": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultUri.value]"
          },
          "enablePrivateNetworking": {
            "value": "[parameters('enablePrivateNetworking')]"
          },
          "appServiceSubnetId": "[if(parameters('enablePrivateNetworking'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.appServiceSubnetId.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "5779075922193615045"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "acrName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "containerImageName": {
              "type": "string"
            },
            "azurePlatform": {
              "type": "string"
            },
            "cosmosDbName": {
              "type": "string"
            },
            "searchServiceName": {
              "type": "string"
            },
            "openAiServiceName": {
              "type": "string"
            },
            "openAiResourceGroupName": {
              "type": "string"
            },
            "documentIntelligenceServiceName": {
              "type": "string"
            },
            "appInsightsName": {
              "type": "string"
            },
            "enterpriseAppClientId": {
              "type": "string",
              "defaultValue": ""
            },
            "authenticationType": {
              "type": "string"
            },
            "enterpriseAppClientSecret": {
              "type": "securestring",
              "defaultValue": ""
            },
            "keyVaultUri": {
              "type": "string"
            },
            "enablePrivateNetworking": {
              "type": "bool"
            },
            "appServiceSubnetId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "acrDomain": "[if(equals(parameters('azurePlatform'), 'AzureUSGovernment'), '.azurecr.us', '.azurecr.io')]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-03-01",
              "name": "[toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "kind": "app,linux,container",
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "virtualNetworkSubnetId": "[if(not(equals(parameters('appServiceSubnetId'), '')), parameters('appServiceSubnetId'), null())]",
                "publicNetworkAccess": "Enabled",
                "vnetImagePullEnabled": "[if(parameters('enablePrivateNetworking'), true(), false())]",
                "siteConfig": {
                  "linuxFxVersion": "[format('DOCKER|{0}', parameters('containerImageName'))]",
                  "acrUseManagedIdentityCreds": true,
                  "acrUserManagedIdentityID": "",
                  "alwaysOn": true,
                  "ftpsState": "Disabled",
                  "healthCheckPath": "/external/healthcheck",
                  "appSettings": "[flatten(createArray(createArray(createObject('name', 'AZURE_ENDPOINT', 'value', if(equals(parameters('azurePlatform'), 'AzureUSGovernment'), 'usgovernment', 'public')), createObject('name', 'SCM_DO_BUILD_DURING_DEPLOYMENT', 'value', 'false'), createObject('name', 'AZURE_COSMOS_ENDPOINT', 'value', reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbName')), '2023-04-15').documentEndpoint), createObject('name', 'AZURE_COSMOS_AUTHENTICATION_TYPE', 'value', toLower(parameters('authenticationType')))), if(equals(parameters('authenticationType'), 'key'), createArray(createObject('name', 'AZURE_COSMOS_KEY', 'value', format('@Microsoft.KeyVault(SecretUri={0}secrets/cosmos-db-key)', parameters('keyVaultUri')))), createArray()), createArray(createObject('name', 'TENANT_ID', 'value', tenant().tenantId), createObject('name', 'CLIENT_ID', 'value', parameters('enterpriseAppClientId')), createObject('name', 'SECRET_KEY', 'value', if(not(empty(parameters('enterpriseAppClientSecret'))), parameters('enterpriseAppClientSecret'), format('@Microsoft.KeyVault(SecretUri={0}secrets/enterprise-app-client-secret)', parameters('keyVaultUri')))), createObject('name', 'MICROSOFT_PROVIDER_AUTHENTICATION_SECRET', 'value', format('@Microsoft.KeyVault(SecretUri={0}secrets/enterprise-app-client-secret)', parameters('keyVaultUri'))), createObject('name', 'DOCKER_REGISTRY_SERVER_URL', 'value', format('https://{0}{1}', parameters('acrName'), variables('acrDomain')))), if(equals(parameters('authenticationType'), 'key'), createArray(createObject('name', 'DOCKER_REGISTRY_SERVER_USERNAME', 'value', listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2025-04-01').username)), createArray()), if(equals(parameters('authenticationType'), 'key'), createArray(createObject('name', 'DOCKER_REGISTRY_SERVER_PASSWORD', 'value', format('@Microsoft.KeyVault(SecretUri={0}secrets/container-registry-key)', parameters('keyVaultUri')))), createArray()), createArray(createObject('name', 'WEBSITE_AUTH_AAD_ALLOWED_TENANTS', 'value', tenant().tenantId), createObject('name', 'AZURE_OPENAI_RESOURCE_NAME', 'value', parameters('openAiServiceName')), createObject('name', 'AZURE_OPENAI_RESOURCE_GROUP_NAME', 'value', parameters('openAiResourceGroupName')), createObject('name', 'AZURE_OPENAI_URL', 'value', reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAiServiceName')), '2024-10-01').endpoint), createObject('name', 'AZURE_SEARCH_SERVICE_NAME', 'value', parameters('searchServiceName'))), if(equals(parameters('authenticationType'), 'key'), createArray(createObject('name', 'AZURE_SEARCH_API_KEY', 'value', format('@Microsoft.KeyVault(SecretUri={0}secrets/search-service-key)', parameters('keyVaultUri')))), createArray()), createArray(createObject('name', 'AZURE_DOCUMENT_INTELLIGENCE_ENDPOINT', 'value', reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('documentIntelligenceServiceName')), '2025-06-01').endpoint)), if(equals(parameters('authenticationType'), 'key'), createArray(createObject('name', 'AZURE_DOCUMENT_INTELLIGENCE_API_KEY', 'value', format('@Microsoft.KeyVault(SecretUri={0}secrets/document-intelligence-key)', parameters('keyVaultUri')))), createArray()), createArray(createObject('name', 'APPINSIGHTS_INSTRUMENTATIONKEY', 'value', reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey), createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString), createObject('name', 'APPINSIGHTS_PROFILERFEATURE_VERSION', 'value', '1.0.0'), createObject('name', 'APPINSIGHTS_SNAPSHOTFEATURE_VERSION', 'value', '1.0.0'), createObject('name', 'APPLICATIONINSIGHTS_CONFIGURATION_CONTENT', 'value', ''), createObject('name', 'ApplicationInsightsAgent_EXTENSION_VERSION', 'value', '~3'), createObject('name', 'DiagnosticServices_EXTENSION_VERSION', 'value', '~3'), createObject('name', 'InstrumentationEngine_EXTENSION_VERSION', 'value', 'disabled'), createObject('name', 'SnapshotDebugger_EXTENSION_VERSION', 'value', 'disabled'), createObject('name', 'XDT_MicrosoftApplicationInsights_BaseExtensions', 'value', 'disabled'), createObject('name', 'XDT_MicrosoftApplicationInsights_Mode', 'value', 'recommended'), createObject('name', 'XDT_MicrosoftApplicationInsights_PreemptSdk', 'value', 'disabled'))))]"
                },
                "clientAffinityEnabled": false,
                "httpsOnly": true
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "tags": "[union(parameters('tags'), createObject('azd-service-name', 'web'))]"
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment'))), 'logs')]",
              "properties": {
                "httpLogs": {
                  "fileSystem": {
                    "enabled": true,
                    "retentionInDays": 7,
                    "retentionInMb": 35
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.webAppLogCategories.value]",
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]",
                "[resourceId('Microsoft.Web/sites', toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment'))), 'authsettingsV2')]",
              "properties": {
                "globalValidation": {
                  "requireAuthentication": true,
                  "unauthenticatedClientAction": "RedirectToLoginPage",
                  "redirectToProvider": "azureActiveDirectory"
                },
                "identityProviders": {
                  "azureActiveDirectory": {
                    "enabled": true,
                    "registration": {
                      "openIdIssuer": "[if(equals(parameters('azurePlatform'), 'AzureUSGovernment'), format('https://login.microsoftonline.us/{0}/', tenant().tenantId), format('https://sts.windows.net/{0}/', tenant().tenantId))]",
                      "clientId": "[parameters('enterpriseAppClientId')]",
                      "clientSecretSettingName": "MICROSOFT_PROVIDER_AUTHENTICATION_SECRET"
                    },
                    "validation": {
                      "jwtClaimChecks": {},
                      "allowedAudiences": [
                        "[format('api://{0}', parameters('enterpriseAppClientId'))]",
                        "[parameters('enterpriseAppClientId')]"
                      ]
                    },
                    "isAutoProvisioned": false
                  }
                },
                "login": {
                  "routes": {
                    "logoutEndpoint": "/.auth/logout"
                  },
                  "tokenStore": {
                    "enabled": true,
                    "tokenRefreshExtensionHours": 72,
                    "fileSystem": {
                      "directory": "/home/data/.auth"
                    }
                  },
                  "preserveUrlFragmentsForLogins": false,
                  "allowedExternalRedirectUrls": [],
                  "cookieExpiration": {
                    "convention": "FixedTime",
                    "timeToExpiration": "08:00:00"
                  },
                  "nonce": {
                    "validateNonce": true,
                    "nonceExpirationInterval": "00:05:00"
                  }
                },
                "httpSettings": {
                  "requireHttps": true,
                  "routes": {
                    "apiPrefix": "/.auth"
                  },
                  "forwardProxy": {
                    "convention": "NoProxy"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment')))]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment')))), '2022-03-01').defaultHostName]"
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', toLower(format('{0}-{1}-app', parameters('appName'), parameters('environment'))))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'azureContainerRegistry')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'applicationInsights')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'appServicePlan')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'cosmosDB')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'docIntel')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'searchService')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'virtualNetwork')]"
      ]
    },
    {
      "condition": "[parameters('deployContentSafety')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "contentSafety",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "keyVault": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "configureApplicationPermissions": {
            "value": "[parameters('configureApplicationPermissions')]"
          },
          "enablePrivateNetworking": {
            "value": "[parameters('enablePrivateNetworking')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "15792786587982505631"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "keyVault": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string"
            },
            "configureApplicationPermissions": {
              "type": "bool"
            },
            "enablePrivateNetworking": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-06-01",
              "name": "[toLower(format('{0}-{1}-contentsafety', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "kind": "ContentSafety",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "publicNetworkAccess": "[if(parameters('enablePrivateNetworking'), 'Disabled', 'Enabled')]",
                "customSubDomainName": "[toLower(format('{0}-{1}-contentsafety', parameters('appName'), parameters('environment')))]"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', toLower(format('{0}-{1}-contentsafety', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-contentsafety', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardLogCategories.value]",
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-contentsafety', parameters('appName'), parameters('environment'))))]",
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[and(equals(parameters('authenticationType'), 'key'), parameters('configureApplicationPermissions'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storeContentSafetySecret",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVault')]"
                  },
                  "secretName": {
                    "value": "content-safety-key"
                  },
                  "secretValue": {
                    "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-contentsafety', parameters('appName'), parameters('environment')))), '2025-06-01').key1]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "18077870757859157550"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2025-05-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "SecretUri": {
                      "type": "string",
                      "value": "[format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2025-05-01').vaultUri, parameters('secretName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-contentsafety', parameters('appName'), parameters('environment'))))]"
              ]
            }
          ],
          "outputs": {
            "contentSafetyName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-contentsafety', parameters('appName'), parameters('environment')))]"
            },
            "contentSafetyEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-contentsafety', parameters('appName'), parameters('environment')))), '2025-06-01').endpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "condition": "[parameters('deployRedisCache')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "redisCache",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "keyVault": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "configureApplicationPermissions": {
            "value": "[parameters('configureApplicationPermissions')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "10855483054816904335"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "keyVault": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string"
            },
            "configureApplicationPermissions": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Cache/redis",
              "apiVersion": "2024-11-01",
              "name": "[toLower(format('{0}-{1}-redis', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "Standard",
                  "family": "C",
                  "capacity": 0
                },
                "enableNonSslPort": false,
                "minimumTlsVersion": "1.2",
                "redisConfiguration": {
                  "aad-enabled": "true"
                }
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Cache/redis/{0}', toLower(format('{0}-{1}-redis', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-redis', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardLogCategories.value]",
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]",
                "[resourceId('Microsoft.Cache/redis', toLower(format('{0}-{1}-redis', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[and(equals(parameters('authenticationType'), 'key'), parameters('configureApplicationPermissions'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storeRedisCacheSecret",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVault')]"
                  },
                  "secretName": {
                    "value": "redis-cache-key"
                  },
                  "secretValue": {
                    "value": "[listKeys(resourceId('Microsoft.Cache/redis', toLower(format('{0}-{1}-redis', parameters('appName'), parameters('environment')))), '2024-11-01').primaryKey]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "18077870757859157550"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2025-05-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "SecretUri": {
                      "type": "string",
                      "value": "[format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2025-05-01').vaultUri, parameters('secretName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cache/redis', toLower(format('{0}-{1}-redis', parameters('appName'), parameters('environment'))))]"
              ]
            }
          ],
          "outputs": {
            "redisCacheName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-redis', parameters('appName'), parameters('environment')))]"
            },
            "redisCacheHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Cache/redis', toLower(format('{0}-{1}-redis', parameters('appName'), parameters('environment')))), '2024-11-01').hostName]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "condition": "[parameters('deploySpeechService')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "speechService",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "keyVault": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "configureApplicationPermissions": {
            "value": "[parameters('configureApplicationPermissions')]"
          },
          "enablePrivateNetworking": {
            "value": "[parameters('enablePrivateNetworking')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "12749834719068646180"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "keyVault": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string"
            },
            "configureApplicationPermissions": {
              "type": "bool"
            },
            "enablePrivateNetworking": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-10-01",
              "name": "[toLower(format('{0}-{1}-speech', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "kind": "SpeechServices",
              "sku": {
                "name": "S0"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "publicNetworkAccess": "[if(parameters('enablePrivateNetworking'), 'Disabled', 'Enabled')]",
                "customSubDomainName": "[toLower(format('{0}-{1}-speech', parameters('appName'), parameters('environment')))]"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', toLower(format('{0}-{1}-speech', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-speech', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardLogCategories.value]",
                "metrics": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.standardMetricsCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]",
                "[resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-speech', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[and(equals(parameters('authenticationType'), 'key'), parameters('configureApplicationPermissions'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storeSpeechServiceSecret",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVault')]"
                  },
                  "secretName": {
                    "value": "speech-service-key"
                  },
                  "secretValue": {
                    "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-speech', parameters('appName'), parameters('environment')))), '2024-10-01').key1]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "18077870757859157550"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2025-05-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "SecretUri": {
                      "type": "string",
                      "value": "[format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2025-05-01').vaultUri, parameters('secretName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-speech', parameters('appName'), parameters('environment'))))]"
              ]
            }
          ],
          "outputs": {
            "speechServiceName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-speech', parameters('appName'), parameters('environment')))]"
            },
            "speechServiceEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', toLower(format('{0}-{1}-speech', parameters('appName'), parameters('environment')))), '2024-10-01').endpoint]"
            },
            "speechServiceAuthenticationType": {
              "type": "string",
              "value": "[parameters('authenticationType')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
      ]
    },
    {
      "condition": "[parameters('deployVideoIndexerService')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "videoIndexerService",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableDiagLogging": {
            "value": "[parameters('enableDiagLogging')]"
          },
          "logAnalyticsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.logAnalyticsId.value]"
          },
          "storageAccount": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'storageAccount'), '2025-04-01').outputs.name.value]"
          },
          "openAiServiceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI'), '2025-04-01').outputs.openAIName.value]"
          },
          "enablePrivateNetworking": {
            "value": "[parameters('enablePrivateNetworking')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "5008986833957108258"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "enableDiagLogging": {
              "type": "bool"
            },
            "logAnalyticsId": {
              "type": "string"
            },
            "storageAccount": {
              "type": "string"
            },
            "openAiServiceName": {
              "type": "string"
            },
            "enablePrivateNetworking": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.VideoIndexer/accounts",
              "apiVersion": "2025-04-01",
              "name": "[toLower(format('{0}-{1}-video', parameters('appName'), parameters('environment')))]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "publicNetworkAccess": "[if(parameters('enablePrivateNetworking'), 'Disabled', 'Enabled')]",
                "storageServices": {
                  "resourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccount'))]"
                },
                "openAiServices": {
                  "resourceId": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('openAiServiceName'))]"
                }
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.VideoIndexer/accounts/{0}', toLower(format('{0}-{1}-video', parameters('appName'), parameters('environment'))))]",
              "name": "[toLower(format('{0}-diagnostics', toLower(format('{0}-{1}-video', parameters('appName'), parameters('environment')))))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsId')]",
                "logs": "[reference(resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs'), '2025-04-01').outputs.limitedLogCategories.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'diagnosticConfigs')]",
                "[resourceId('Microsoft.VideoIndexer/accounts', toLower(format('{0}-{1}-video', parameters('appName'), parameters('environment'))))]"
              ]
            },
            {
              "condition": "[parameters('enableDiagLogging')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "diagnosticConfigs",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "14992132232820252472"
                    }
                  },
                  "variables": {
                    "standardRetentionPolicy": {
                      "enabled": false,
                      "days": 0
                    },
                    "standardLogCategories": [
                      {
                        "categoryGroup": "Audit",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "limitedLogCategories": [
                      {
                        "categoryGroup": "allLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "standardMetricsCategories": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "transactionMetricsCategories": [
                      {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ],
                    "webAppLogCategories": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      },
                      {
                        "category": "AppServiceAuthenticationLogs",
                        "enabled": true,
                        "retentionPolicy": "[variables('standardRetentionPolicy')]"
                      }
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "limitedLogCategories": {
                      "type": "array",
                      "value": "[variables('limitedLogCategories')]"
                    },
                    "standardRetentionPolicy": {
                      "type": "object",
                      "value": "[variables('standardRetentionPolicy')]"
                    },
                    "standardLogCategories": {
                      "type": "array",
                      "value": "[variables('standardLogCategories')]"
                    },
                    "standardMetricsCategories": {
                      "type": "array",
                      "value": "[variables('standardMetricsCategories')]"
                    },
                    "transactionMetricsCategories": {
                      "type": "array",
                      "value": "[variables('transactionMetricsCategories')]"
                    },
                    "webAppLogCategories": {
                      "type": "array",
                      "value": "[variables('webAppLogCategories')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "videoIndexerServiceName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-video', parameters('appName'), parameters('environment')))]"
            },
            "videoIndexerAccountId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.VideoIndexer/accounts', toLower(format('{0}-{1}-video', parameters('appName'), parameters('environment')))), '2025-04-01').accountId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'logAnalytics')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'storageAccount')]"
      ]
    },
    {
      "condition": "[parameters('configureApplicationPermissions')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "setPermissions",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "webAppName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.name.value]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "enterpriseAppServicePrincipalId": {
            "value": "[parameters('enterpriseAppServicePrincipalId')]"
          },
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "cosmosDBName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'cosmosDB'), '2025-04-01').outputs.cosmosDbName.value]"
          },
          "acrName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'azureContainerRegistry'), '2025-04-01').outputs.acrName.value]"
          },
          "openAIName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI'), '2025-04-01').outputs.openAIName.value]"
          },
          "docIntelName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'docIntel'), '2025-04-01').outputs.documentIntelligenceServiceName.value]"
          },
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'storageAccount'), '2025-04-01').outputs.name.value]"
          },
          "searchServiceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'searchService'), '2025-04-01').outputs.searchServiceName.value]"
          },
          "speechServiceName": "[if(parameters('deploySpeechService'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'speechService'), '2025-04-01').outputs.speechServiceName.value), createObject('value', ''))]",
          "redisCacheName": "[if(parameters('deployRedisCache'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'redisCache'), '2025-04-01').outputs.redisCacheName.value), createObject('value', ''))]",
          "contentSafetyName": "[if(parameters('deployContentSafety'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'contentSafety'), '2025-04-01').outputs.contentSafetyName.value), createObject('value', ''))]",
          "videoIndexerName": "[if(parameters('deployVideoIndexerService'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'videoIndexerService'), '2025-04-01').outputs.videoIndexerServiceName.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17165122895470513967"
            }
          },
          "parameters": {
            "webAppName": {
              "type": "string"
            },
            "authenticationType": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            },
            "enterpriseAppServicePrincipalId": {
              "type": "string"
            },
            "cosmosDBName": {
              "type": "string"
            },
            "acrName": {
              "type": "string"
            },
            "openAIName": {
              "type": "string"
            },
            "docIntelName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "speechServiceName": {
              "type": "string"
            },
            "searchServiceName": {
              "type": "string"
            },
            "redisCacheName": {
              "type": "string"
            },
            "contentSafetyName": {
              "type": "string"
            },
            "videoIndexerName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'kv-secrets-user')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[equals(parameters('authenticationType'), 'managed_identity')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('cosmosDBName'))]",
              "name": "[guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'cosmos-contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[equals(parameters('authenticationType'), 'managed_identity')]",
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('cosmosDBName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'cosmos-data-contributor'))]",
              "properties": {
                "roleDefinitionId": "[format('{0}/sqlRoleDefinitions/00000000-0000-0000-0000-000000000002', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName')))]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName'))]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'acr-pull-role')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[equals(parameters('authenticationType'), 'managed_identity')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'openai-user')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5e0bd9bd-7b93-4f28-af87-19fc36ad61bd')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[equals(parameters('authenticationType'), 'managed_identity')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'enterpriseApp-CognitiveServicesOpenAIUserRole')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5e0bd9bd-7b93-4f28-af87-19fc36ad61bd')]",
                "principalId": "[parameters('enterpriseAppServicePrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[equals(parameters('authenticationType'), 'managed_identity')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('docIntelName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('docIntelName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'doc-intel-user')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[equals(parameters('authenticationType'), 'managed_identity')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'storage-blob-data-contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(equals(parameters('speechServiceName'), '')), equals(parameters('authenticationType'), 'managed_identity'))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('speechServiceName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('speechServiceName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'speech-service-user')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[equals(parameters('authenticationType'), 'managed_identity')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('searchServiceName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('searchServiceName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'search-index-data-contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[equals(parameters('authenticationType'), 'managed_identity')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('searchServiceName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('searchServiceName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'search-service-contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7ca78c08-252a-4471-8644-bb5ff32d4ba0')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(equals(parameters('contentSafetyName'), '')), equals(parameters('authenticationType'), 'managed_identity'))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('contentSafetyName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('contentSafetyName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'content-safety-user')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(equals(parameters('videoIndexerName'), ''))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.VideoIndexer/accounts', parameters('videoIndexerName')), 'video-indexer-storage-blob-data-contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[reference(resourceId('Microsoft.VideoIndexer/accounts', parameters('videoIndexerName')), '2025-04-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(equals(parameters('videoIndexerName'), ''))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), resourceId('Microsoft.VideoIndexer/accounts', parameters('videoIndexerName')), 'video-indexer-cog-services-contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68')]",
                "principalId": "[reference(resourceId('Microsoft.VideoIndexer/accounts', parameters('videoIndexerName')), '2025-04-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(equals(parameters('videoIndexerName'), ''))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), resourceId('Microsoft.VideoIndexer/accounts', parameters('videoIndexerName')), 'video-indexer-cog-services-user')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]",
                "principalId": "[reference(resourceId('Microsoft.VideoIndexer/accounts', parameters('videoIndexerName')), '2025-04-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(equals(parameters('redisCacheName'), ''))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Cache/redis/{0}', parameters('redisCacheName'))]",
              "name": "[guid(resourceId('Microsoft.Cache/redis', parameters('redisCacheName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), 'redis-cache-contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e0f68234-74aa-48ed-b826-c38b57376e17')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'azureContainerRegistry')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'appService')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'contentSafety')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'cosmosDB')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'docIntel')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'redisCache')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'searchService')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'speechService')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'storageAccount')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'videoIndexerService')]"
      ]
    },
    {
      "condition": "[parameters('enablePrivateNetworking')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "privateNetworking",
      "resourceGroup": "[variables('rgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualNetworkId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.vNetId.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.privateNetworkSubnetId.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "cosmosDBName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'cosmosDB'), '2025-04-01').outputs.cosmosDbName.value]"
          },
          "acrName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'azureContainerRegistry'), '2025-04-01').outputs.acrName.value]"
          },
          "searchServiceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'searchService'), '2025-04-01').outputs.searchServiceName.value]"
          },
          "docIntelName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'docIntel'), '2025-04-01').outputs.documentIntelligenceServiceName.value]"
          },
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'storageAccount'), '2025-04-01').outputs.name.value]"
          },
          "openAIName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI'), '2025-04-01').outputs.openAIName.value]"
          },
          "webAppName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.name.value]"
          },
          "contentSafetyName": "[if(parameters('deployContentSafety'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'contentSafety'), '2025-04-01').outputs.contentSafetyName.value), createObject('value', ''))]",
          "speechServiceName": "[if(parameters('deploySpeechService'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'speechService'), '2025-04-01').outputs.speechServiceName.value), createObject('value', ''))]",
          "videoIndexerName": "[if(parameters('deployVideoIndexerService'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'videoIndexerService'), '2025-04-01').outputs.videoIndexerServiceName.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "3584007603660948740"
            }
          },
          "parameters": {
            "virtualNetworkId": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "appName": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "keyVaultName": {
              "type": "string"
            },
            "cosmosDBName": {
              "type": "string"
            },
            "acrName": {
              "type": "string"
            },
            "searchServiceName": {
              "type": "string"
            },
            "docIntelName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "openAIName": {
              "type": "string"
            },
            "webAppName": {
              "type": "string"
            },
            "contentSafetyName": {
              "type": "string"
            },
            "speechServiceName": {
              "type": "string"
            },
            "videoIndexerName": {
              "type": "string"
            }
          },
          "variables": {
            "$fxv#0": {
              "azurecloud": {
                "aisearch": "privatelink.search.windows.net",
                "blobStorage": "privatelink.blob.core.windows.net",
                "cognitiveServices": "privatelink.cognitiveservices.azure.com",
                "containerRegistry": "privatelink.azurecr.io",
                "cosmosDb": "privatelink.documents.azure.com",
                "keyVault": "privatelink.vaultcore.azure.net",
                "openAi": "privatelink.openai.azure.com",
                "webSites": "privatelink.azurewebsites.net"
              },
              "azureusgovernment": {
                "aisearch": "privatelink.search.azure.us",
                "blobStorage": "privatelink.blob.core.usgovcloudapi.net",
                "cognitiveServices": "privatelink.cognitiveservices.azure.us",
                "containerRegistry": "privatelink.azurecr.us",
                "cosmosDb": "privatelink.documents.azure.us",
                "keyVault": "privatelink.vaultcore.azure.us",
                "openAi": "privatelink.openai.azure.us",
                "webSites": "privatelink.azurewebsites.us"
              }
            },
            "cloudName": "[toLower(environment().name)]",
            "privateDnsZoneData": "[variables('$fxv#0')]",
            "aiSearchDnsZoneName": "[variables('privateDnsZoneData')[variables('cloudName')].aisearch]",
            "blobStorageDnsZoneName": "[variables('privateDnsZoneData')[variables('cloudName')].blobStorage]",
            "cognitiveServicesDnsZoneName": "[variables('privateDnsZoneData')[variables('cloudName')].cognitiveServices]",
            "containerRegistryDnsZoneName": "[variables('privateDnsZoneData')[variables('cloudName')].containerRegistry]",
            "cosmosDbDnsZoneName": "[variables('privateDnsZoneData')[variables('cloudName')].cosmosDb]",
            "keyVaultDnsZoneName": "[variables('privateDnsZoneData')[variables('cloudName')].keyVault]",
            "openAiDnsZoneName": "[variables('privateDnsZoneData')[variables('cloudName')].openAi]",
            "webSitesDnsZoneName": "[variables('privateDnsZoneData')[variables('cloudName')].webSites]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "keyVaultDNSZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[variables('keyVaultDnsZoneName')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "name": {
                    "value": "kv"
                  },
                  "vNetId": {
                    "value": "[parameters('virtualNetworkId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "6963784194716310503"
                    }
                  },
                  "parameters": {
                    "zoneName": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "vNetId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('zoneName')]",
                      "location": "global",
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/{1}', parameters('zoneName'), toLower(format('{0}-{1}-{2}-pe-dnszonelink', parameters('appName'), parameters('environment'), parameters('name'))))]",
                      "location": "global",
                      "properties": {
                        "registrationEnabled": false,
                        "virtualNetwork": {
                          "id": "[parameters('vNetId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateDnsZoneId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                    },
                    "privateDnsZoneName": {
                      "type": "string",
                      "value": "[parameters('zoneName')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "keyVaultPE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "kv"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "vault"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'keyVaultDNSZone')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "cosmosDbDNSZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[variables('cosmosDbDnsZoneName')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "name": {
                    "value": "cosmosDb"
                  },
                  "vNetId": {
                    "value": "[parameters('virtualNetworkId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "6963784194716310503"
                    }
                  },
                  "parameters": {
                    "zoneName": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "vNetId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('zoneName')]",
                      "location": "global",
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/{1}', parameters('zoneName'), toLower(format('{0}-{1}-{2}-pe-dnszonelink', parameters('appName'), parameters('environment'), parameters('name'))))]",
                      "location": "global",
                      "properties": {
                        "registrationEnabled": false,
                        "virtualNetwork": {
                          "id": "[parameters('vNetId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateDnsZoneId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                    },
                    "privateDnsZoneName": {
                      "type": "string",
                      "value": "[parameters('zoneName')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "cosmosDbPE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "cosmosDb"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "sql"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'cosmosDbDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'cosmosDbDNSZone')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "acrDNSZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[variables('containerRegistryDnsZoneName')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "name": {
                    "value": "acr"
                  },
                  "vNetId": {
                    "value": "[parameters('virtualNetworkId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "6963784194716310503"
                    }
                  },
                  "parameters": {
                    "zoneName": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "vNetId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('zoneName')]",
                      "location": "global",
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/{1}', parameters('zoneName'), toLower(format('{0}-{1}-{2}-pe-dnszonelink', parameters('appName'), parameters('environment'), parameters('name'))))]",
                      "location": "global",
                      "properties": {
                        "registrationEnabled": false,
                        "virtualNetwork": {
                          "id": "[parameters('vNetId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateDnsZoneId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                    },
                    "privateDnsZoneName": {
                      "type": "string",
                      "value": "[parameters('zoneName')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "acrPE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "acr"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "registry"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'acrDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'acrDNSZone')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "searchServiceDNSZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[variables('aiSearchDnsZoneName')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "name": {
                    "value": "searchService"
                  },
                  "vNetId": {
                    "value": "[parameters('virtualNetworkId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "6963784194716310503"
                    }
                  },
                  "parameters": {
                    "zoneName": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "vNetId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('zoneName')]",
                      "location": "global",
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/{1}', parameters('zoneName'), toLower(format('{0}-{1}-{2}-pe-dnszonelink', parameters('appName'), parameters('environment'), parameters('name'))))]",
                      "location": "global",
                      "properties": {
                        "registrationEnabled": false,
                        "virtualNetwork": {
                          "id": "[parameters('vNetId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateDnsZoneId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                    },
                    "privateDnsZoneName": {
                      "type": "string",
                      "value": "[parameters('zoneName')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "searchServicePE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "searchService"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.Search/searchServices', parameters('searchServiceName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "searchService"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'searchServiceDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'searchServiceDNSZone')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "docIntelDNSZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[variables('cognitiveServicesDnsZoneName')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "name": {
                    "value": "docIntelService"
                  },
                  "vNetId": {
                    "value": "[parameters('virtualNetworkId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "6963784194716310503"
                    }
                  },
                  "parameters": {
                    "zoneName": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "vNetId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('zoneName')]",
                      "location": "global",
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/{1}', parameters('zoneName'), toLower(format('{0}-{1}-{2}-pe-dnszonelink', parameters('appName'), parameters('environment'), parameters('name'))))]",
                      "location": "global",
                      "properties": {
                        "registrationEnabled": false,
                        "virtualNetwork": {
                          "id": "[parameters('vNetId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateDnsZoneId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                    },
                    "privateDnsZoneName": {
                      "type": "string",
                      "value": "[parameters('zoneName')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "docIntelPE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "docIntelService"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('docIntelName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "account"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'docIntelDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'docIntelDNSZone')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storageAccountDNSZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[variables('blobStorageDnsZoneName')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "name": {
                    "value": "storage"
                  },
                  "vNetId": {
                    "value": "[parameters('virtualNetworkId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "6963784194716310503"
                    }
                  },
                  "parameters": {
                    "zoneName": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "vNetId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('zoneName')]",
                      "location": "global",
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/{1}', parameters('zoneName'), toLower(format('{0}-{1}-{2}-pe-dnszonelink', parameters('appName'), parameters('environment'), parameters('name'))))]",
                      "location": "global",
                      "properties": {
                        "registrationEnabled": false,
                        "virtualNetwork": {
                          "id": "[parameters('vNetId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateDnsZoneId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                    },
                    "privateDnsZoneName": {
                      "type": "string",
                      "value": "[parameters('zoneName')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storageAccountPE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "storageAccount"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "blob"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccountDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'storageAccountDNSZone')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "openAiDNSZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[variables('openAiDnsZoneName')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "name": {
                    "value": "openAiService"
                  },
                  "vNetId": {
                    "value": "[parameters('virtualNetworkId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "6963784194716310503"
                    }
                  },
                  "parameters": {
                    "zoneName": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "vNetId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('zoneName')]",
                      "location": "global",
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/{1}', parameters('zoneName'), toLower(format('{0}-{1}-{2}-pe-dnszonelink', parameters('appName'), parameters('environment'), parameters('name'))))]",
                      "location": "global",
                      "properties": {
                        "registrationEnabled": false,
                        "virtualNetwork": {
                          "id": "[parameters('vNetId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateDnsZoneId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                    },
                    "privateDnsZoneName": {
                      "type": "string",
                      "value": "[parameters('zoneName')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "openAiPE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "openAiService"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "account"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'openAiDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'openAiDNSZone')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "webAppDNSZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[variables('webSitesDnsZoneName')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "name": {
                    "value": "webApp"
                  },
                  "vNetId": {
                    "value": "[parameters('virtualNetworkId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "6963784194716310503"
                    }
                  },
                  "parameters": {
                    "zoneName": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "vNetId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('zoneName')]",
                      "location": "global",
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/{1}', parameters('zoneName'), toLower(format('{0}-{1}-{2}-pe-dnszonelink', parameters('appName'), parameters('environment'), parameters('name'))))]",
                      "location": "global",
                      "properties": {
                        "registrationEnabled": false,
                        "virtualNetwork": {
                          "id": "[parameters('vNetId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateDnsZoneId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                    },
                    "privateDnsZoneName": {
                      "type": "string",
                      "value": "[parameters('zoneName')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "webAppPE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "webApp"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "sites"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'webAppDNSZone')]"
              ]
            },
            {
              "condition": "[not(equals(parameters('contentSafetyName'), ''))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "contentSafetyPE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "contentSafety"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('contentSafetyName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "account"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'docIntelDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'docIntelDNSZone')]"
              ]
            },
            {
              "condition": "[not(equals(parameters('speechServiceName'), ''))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "speechServicePE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "speechService"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('speechServiceName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "account"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'docIntelDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'docIntelDNSZone')]"
              ]
            },
            {
              "condition": "[not(equals(parameters('videoIndexerName'), ''))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "videoIndexerPE",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "videoIndexerService"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appName": {
                    "value": "[parameters('appName')]"
                  },
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "serviceResourceID": {
                    "value": "[resourceId('Microsoft.VideoIndexer/accounts', parameters('videoIndexerName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "groupIDs": {
                    "value": [
                      "account"
                    ]
                  },
                  "privateDnsZoneIds": {
                    "value": [
                      "[reference(resourceId('Microsoft.Resources/deployments', 'docIntelDNSZone'), '2025-04-01').outputs.privateDnsZoneId.value]"
                    ]
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "1838240609393686445"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "appName": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string"
                    },
                    "serviceResourceID": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "groupIDs": {
                      "type": "array"
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[greater(length(parameters('privateDnsZoneIds')), 0)]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[last(split(parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')], '/'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-05-01",
                      "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[toLower(format('{0}-{1}-{2}-pe', parameters('appName'), parameters('environment'), parameters('name')))]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('serviceResourceID')]",
                              "groupIds": "[parameters('groupIDs')]"
                            }
                          }
                        ],
                        "customNetworkInterfaceName": "[toLower(format('{0}-{1}-{2}-nic', parameters('appName'), parameters('environment'), parameters('name')))]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'docIntelDNSZone')]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'azureContainerRegistry')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'appService')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'contentSafety')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'cosmosDB')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'docIntel')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'searchService')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'speechService')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'storageAccount')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'videoIndexerService')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'virtualNetwork')]"
      ]
    }
  ],
  "outputs": {
    "var_acrName": {
      "type": "string",
      "value": "[toLower(format('{0}{1}acr', parameters('appName'), parameters('environment')))]"
    },
    "var_authenticationType": {
      "type": "string",
      "value": "[toLower(parameters('authenticationType'))]"
    },
    "var_blobStorageEndpoint": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'storageAccount'), '2025-04-01').outputs.endpoint.value]"
    },
    "var_configureApplication": {
      "type": "bool",
      "value": "[parameters('configureApplicationPermissions')]"
    },
    "var_contentSafetyEndpoint": {
      "type": "string",
      "value": "[if(parameters('deployContentSafety'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'contentSafety'), '2025-04-01').outputs.contentSafetyEndpoint.value, '')]"
    },
    "var_cosmosDb_accountName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'cosmosDB'), '2025-04-01').outputs.cosmosDbName.value]"
    },
    "var_cosmosDb_uri": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'cosmosDB'), '2025-04-01').outputs.cosmosDbUri.value]"
    },
    "var_deploymentLocation": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName')), '2022-09-01', 'full').location]"
    },
    "var_documentIntelligenceServiceEndpoint": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'docIntel'), '2025-04-01').outputs.documentIntelligenceServiceEndpoint.value]"
    },
    "var_keyVaultName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "var_keyVaultUri": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultUri.value]"
    },
    "var_openAIEndpoint": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI'), '2025-04-01').outputs.openAIEndpoint.value]"
    },
    "var_openAIGPTModels": {
      "type": "array",
      "value": "[parameters('gptModels')]"
    },
    "var_openAIResourceGroup": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'openAI'), '2025-04-01').outputs.openAIResourceGroup.value]"
    },
    "var_openAIEmbeddingModels": {
      "type": "array",
      "value": "[parameters('embeddingModels')]"
    },
    "var_redisCacheHostName": {
      "type": "string",
      "value": "[if(parameters('deployRedisCache'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'redisCache'), '2025-04-01').outputs.redisCacheHostName.value, '')]"
    },
    "var_rgName": {
      "type": "string",
      "value": "[variables('rgName')]"
    },
    "var_searchServiceEndpoint": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'searchService'), '2025-04-01').outputs.searchServiceEndpoint.value]"
    },
    "var_speechServiceEndpoint": {
      "type": "string",
      "value": "[if(parameters('deploySpeechService'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'speechService'), '2025-04-01').outputs.speechServiceEndpoint.value, '')]"
    },
    "var_subscriptionId": {
      "type": "string",
      "value": "[subscription().subscriptionId]"
    },
    "var_videoIndexerAccountId": {
      "type": "string",
      "value": "[if(parameters('deployVideoIndexerService'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'videoIndexerService'), '2025-04-01').outputs.videoIndexerAccountId.value, '')]"
    },
    "var_videoIndexerName": {
      "type": "string",
      "value": "[if(parameters('deployVideoIndexerService'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'videoIndexerService'), '2025-04-01').outputs.videoIndexerServiceName.value, '')]"
    },
    "var_containerRegistry": {
      "type": "string",
      "value": "[variables('containerRegistry')]"
    },
    "var_imageName": {
      "type": "string",
      "value": "[if(contains(parameters('imageName'), ':'), split(parameters('imageName'), ':')[0], parameters('imageName'))]"
    },
    "var_imageTag": {
      "type": "string",
      "value": "[split(parameters('imageName'), ':')[1]]"
    },
    "var_webService": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.name.value]"
    },
    "var_enablePrivateNetworking": {
      "type": "bool",
      "value": "[parameters('enablePrivateNetworking')]"
    }
  }
}