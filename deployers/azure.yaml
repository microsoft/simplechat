name: SimpleChat
metadata:
  template: custom
infra:
  provider: bicep
  path: bicep
services:
  web:
    project: ../application/single_app
    language: python
    host: appservice
    docker:
      context: ../../
      dockerfile: application/single_app/Dockerfile
hooks:
  postprovision:
  # this is run after the infrastructure has been provisioned but before services are deployed.
  # primary use is to configure application settings and permissions
    posix:
      shell: sh
      run: |
        # Set up variables
        export var_acrName=${var_acrname}
        export var_configureApplication=${var_configureApplication}
        export var_cosmosDb_uri=${var_cosmosDb_uri}
        export var_cosmosDb_accountName=${var_cosmosDb_accountName}
        export var_subscriptionId=${AZURE_SUBSCRIPTION_ID}
        export var_rgName=${var_rgName}
        export var_keyVaultUri=${var_keyVaultUri}
        export var_keyVaultName=${var_keyVaultName}
        export var_authenticationType=${var_authenticationType}
        export var_openAIEndpoint=${var_openAIEndpoint}
        export var_openAIResourceGroup=${var_openAIResourceGroup}
        export var_openAIGPTModel=${var_openAIGPTModel}
        export var_openAITextEmbeddingModel=${var_openAITextEmbeddingModel}
        export var_blobStorageEndpoint=${var_blobStorageEndpoint}
        export var_contentSafetyEndpoint=${var_contentSafetyEndpoint}
        export var_searchServiceEndpoint=${var_searchServiceEndpoint}
        export var_documentIntelligenceServiceEndpoint=${var_documentIntelligenceServiceEndpoint}
        export var_redisCacheHostName=${var_redisCacheHostName}
        export var_videoIndexerName=${var_videoIndexerName}
        export var_deploymentLocation=${var_deploymentLocation}
        export var_videoIndexerAccountId=${var_videoIndexerAccountId}
        export var_speechServiceEndpoint=${var_speechServiceEndpoint}
        # export var_vNetId=${var_vNetId}

        # Execute post-configuration script if enabled
        if [ "${var_configureApplication}" = "true" ]; then
            echo "Grant permissions to CosmosDB for post deployment steps..."
            bash ./bicep/cosmosDb-postDeployPerms.sh
            echo "Running post-deployment configuration..."
            python3 -m pip install --user -r ./bicep/requirements.txt
            python3 ./bicep/postconfig.py
            echo "Post-deployment configuration completed."
            echo "Restarting web service to apply new settings..."
            az webapp restart --name ${var_webService} --resource-group ${var_rgName}
            echo "Web service restarted."
        else
            echo "Skipping post-deployment configuration (var_configureApplication is not true)"
        fi
  predeploy:
  # this is run after infrastructure and postprovisioning but before service deployment
  # primary use is to build and push container images
    posix:
      shell: sh
      run: |
        # Build and push Docker image to ACR
        cd ..
        timestamp="$(date +"%Y%m%d-%H%M%S")"
        echo "Stopping web service prior to deployment..."
        az webapp stop --name ${var_webService} --resource-group ${var_rgName}
        echo "Building Docker image..."
        docker build -f application/single_app/Dockerfile -t ${var_containerRegistry}/${var_imageName}:${timestamp} .
        docker tag ${var_containerRegistry}/${var_imageName}:${timestamp} ${var_containerRegistry}/${var_imageName}:latest
        echo "Logging in to ACR..."
        az acr login --name ${var_acrName}
        echo "Pushing image to ACR..."
        docker push ${var_containerRegistry}/${var_imageName}:latest
        docker push ${var_containerRegistry}/${var_imageName}:${timestamp}
        echo "Restarting web service..."
        az webapp start --name ${var_webService} --resource-group ${var_rgName}
  
  postup:
    # this is the final step to run after everything else is done
    # primary use is disable public network access if private endpoints are used
    posix:
      shell: sh
      run: |
        # If using private endpoints, disable cosmos and key vault public interface
        if [ "${var_enablePrivateNetworking}" = "true" ]; then
            echo "Disabling public network access for CosmosDB..."

            echo "Disabling public network access for CosmosDB..."
            az cosmosdb update --name ${var_cosmosDb_accountName} --resource-group ${var_rgName} --public-network-access Disabled
            echo "Public network access for CosmosDB disabled."
            
            echo "Disabling public network access for Key Vault..."
            az keyvault update --name ${var_keyVaultName} --resource-group ${var_rgName} --public-network-access Disabled
            echo "Public network access for Key Vault disabled."

            echo "Disabling public network access for Azure Container Registry..."
            az acr update --name ${var_acrName} --resource-group ${var_rgName} --public-network-enabled false
            echo "Public network access for Azure Container Registry disabled."

            # echo "Disabling public network access for Web Application..."
            # az webapp update --name ${var_webService} --resource-group ${var_rgName} --public-network-access Disabled
            # echo "Public network access for Web Application disabled."
        else
            echo "Skipping disabling public network access for CosmosDB, Key Vault, and Azure Container Registry (var_enablePrivateNetworking is not true)"
        fi

        echo "Deployment completed successfully."
